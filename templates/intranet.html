<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intranet RRHH - Gestión de Currículums</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for graphics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe; /* Light blue background */
            display: flex;
            flex-direction: column; /* Default to column for general layout */
            align-items: center; /* Center content horizontally */
            min-height: 100vh;
            padding: 1rem; /* Adjust padding for overall page */
            position: relative;
            box-sizing: border-box; /* Ensure padding doesn't cause overflow */
            overflow-x: hidden; /* Prevent horizontal scrollbar from body */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Regla fundamental para ocultar paneles de pestañas inactivas */
        .tab-pane:not(.active) {
            display: none;
        }

        /* Regla para ocultar paneles de sub-pestañas inactivas */
        .personal-sub-tab-content:not(.active) {
            display: none;
        }

        /* Basic styling for disabled inputs */
        input:disabled, select:disabled, textarea:disabled {
            background-color: #e2e8f0; /* bg-gray-200 */
            cursor: not-allowed;
        }
        .notification-active {
            border: 2px solid #2563eb; /* blue-600 */
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
            to { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
        }

        /* Styles for the floating menu toggle (hamburger) - Top Left now */
        #menu-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem; /* Position to the left */
            z-index: 1000;
            display: none; /* Hidden by default, shown when HR logs in */
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 9999px; /* Full rounded for a circular look */
            background-color: #2563eb; /* Dark blue */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out, left 0.3s ease-in-out; /* Added left transition */
        }

        #menu-toggle:hover {
            transform: scale(1.05);
        }

        #menu-toggle.menu-pushed {
            left: 290px; /* Moves it right past the opened menu (280px + 1rem padding + some gap) */
        }

        #menu-count {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem; /* Position to the right of the button */
            background-color: #1e3a8a; /* Darkest blue for contrast */
            color: white;
            border-radius: 9999px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            height: 1.5rem;
        }

        /* Styles for the floating notification bell - Top Right now */
        #notification-bell {
            position: fixed;
            top: 1rem;
            right: 1rem; /* Position to the right */
            z-index: 1000;
            display: none; /* Hidden by default, shown when HR logs in */
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 9999px;
            background-color: #bfdbfe; /* Light blue */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }

        #notification-bell:hover {
            transform: scale(1.05);
        }

        #notification-bell-count {
            position: absolute;
            top: -0.5rem;
            left: -0.5rem; /* Position to the left of the bell */
            background-color: #1e3a8a; /* Darkest blue for contrast */
            color: white;
            border-radius: 9999px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            height: 1.5rem;
        }

        .hr-content-area-with-menu {
            margin-left: 500px; /* Ajusta este valor al ancho de tu menú lateral */
            transition: margin-left 0.3s;
        }

        /* Styles for the main HR layout container */
        #hr-main-layout {
            /* 'display: flex' will be added by JavaScript using Tailwind's 'flex' class when visible */
            flex-direction: column; /* Changed to column to stack elements inside */
            align-items: center; /* Center content horizontally */
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            min-height: calc(100vh - 12rem); /* Adjust based on header height */
            margin-top: 1rem; /* Space below global header */
            transition: margin-left 0.3s ease-in-out; /* Add transition for smoothness */
        }

        /* New class to push the main layout when the menu is open */
        #hr-main-layout.menu-pushed {
            margin-left: 280px; /* Width of the menu */
        }

        /* Styles for the left sliding menu panel (HR Menu) */
        #hr-menu-panel {
            position: fixed; /* Take out of document flow */
            top: 0;
            left: -280px; /* Start off-screen to the left (same as open width) */
            width: 280px; /* Fixed width for desktop menu */
            height: 100vh; /* Cover full viewport height */
            background-color: #ffffff; /* White background */
            z-index: 999; /* Still above content when open */
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1); /* Shadow to the right when it slides in */
            transition: left 0.3s ease-in-out; /* Transition 'left' property */
            padding: 1.5rem; /* Padding applied when open */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push logout to bottom */
            box-sizing: border-box; /* Include padding in width calculation */
        }

        #hr-menu-panel.open {
            left: 0; /* Slide into view */
        }

        /* Styles for the main HR content area */
        #hr-content-area {
            flex-grow: 1; /* Takes remaining space */
            padding: 1.5rem; /* Consistent padding */
            background-color: #ffffff; /* White background */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* shadow-2xl */
            border: 1px solid #f3f4f6; /* border-gray-100 */
            overflow-x: hidden; /* Prevent horizontal scroll on content area */
            max-width: 1100px;        /* Ajusta este valor según tu preferencia */
            margin-left: auto;
            margin-right: auto;
            width: 100%; /* Ensure it takes full available width */
            transition: all 0.3s ease-in-out; /* Smooth transition for content adjustments */
        }

        /* Styles for the floating notification popup (Assistance Requests) - Aligned with bell */
        #assistance-notification-popup {
            position: fixed;
            top: 4.5rem; /* Below the bell icon */
            right: 1rem; /* Aligned with bell icon on the right */
            left: auto; /* Ensure it doesn't try to align left */
            max-width: 350px;
            width: 90%;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001; /* Above menu panel */
            padding: 1.5rem;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 1rem;
            max-height: 80vh; /* Limit height for scrolling */
            overflow-y: auto;
            transform: scale(0.9); /* Start slightly smaller for animation */
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
            transform-origin: top right; /* Origin for scaling */
        }

        #assistance-notification-popup.open {
            display: flex;
            transform: scale(1);
            opacity: 1;
        }

        /* Style for individual assistance request items */
        .assistance-request-item {
            border-bottom: 1px solid #e2e8f0; /* Light gray border for separation */
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .assistance-request-item:last-child {
            border-bottom: none; /* No border for the last item */
            margin-bottom: 0;
        }

        /* Style for progress bar */
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            height: 10px;
        }
        .progress-bar {
            height: 100%;
            background-color: #2563eb; /* blue-600 */
            width: 0%; /* Will be set by JS */
            transition: width 0.5s ease-in-out;
            border-radius: 5px;
        }

        #employee-list-container {
            max-height: 1000px;    /* Puedes ajustar este valor según lo que prefieras */
            overflow-y: auto;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            #hr-menu-panel {
                left: -70%; /* Start off-screen */
                width: 70%; /* Larger width on smaller screens */
            }
            #hr-menu-panel.open {
                left: 0;
            }
            #hr-main-layout.menu-pushed {
                margin-left: 70%; /* 70% of screen width for menu on small screens */
            }
            #menu-toggle.menu-pushed {
                left: calc(70% + 1rem); /* Adjust based on menu width + padding */
            }
            #assistance-notification-popup {
                right: 1rem; /* Keep aligned right on smaller screens */
                left: auto; /* Ensure it doesn't try to align left */
                transform-origin: top right;
            }
        }

        /* Sub-tab styling */
        .sub-tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0; /* Rounded top corners */
            border-bottom: 2px solid transparent;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            font-weight: 500;
        }
        .sub-tab-button.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .sub-tab-button:not(.active):hover {
            background-color: #e2e8f0; /* gray-200 */
        }
        .sub-tab-content {
            display: none;
            padding-top: 1rem; /* Space below tabs */
        }
        .sub-tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="selection:bg-blue-300 selection:text-blue-900">

    <!-- Floating Notification Bell - Top Right -->
    <div id="notification-bell" class="relative">
        <!-- Bell Icon SVG -->
        <svg class="w-8 h-8 text-blue-800" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 10V6c0-3.31-2.69-6-6-6S6 2.69 6 6v4l-2 3v3h16v-3l-2-3zM12 21c-1.66 0-3-1.34-3-3h6c0 1.66-1.34 3-3 3z"></path></svg>
        <span id="notification-bell-count" class="hidden">0</span>
    </div>

    <!-- Floating Menu Toggle (Hamburger Icon) - Top Left -->
    <div id="menu-toggle" class="relative">
        <!-- Hamburger Icon SVG -->
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
        <span id="menu-count" class="hidden">0</span>
    </div>
    
    <!-- Floating Notification Popup (for assistance requests) - Aligned with bell -->
    <div id="assistance-notification-popup" class="bg-blue-50 p-6 rounded-lg shadow-inner">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Solicitudes de Asistencia</h3>
            <button id="close-assistance-popup-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
        </div>
        <p id="popup-status-message" class="text-center text-blue-800 text-sm mb-4 hidden"></p>
        <ul id="pending-requests-list" class="space-y-3 text-gray-700">
            <li>No hay solicitudes pendientes.</li>
        </ul>
    </div>

    <!-- Solicitar Asistencia Button and Message (for Personal Access, positioned outside HR layout) -->
    <button id="btn-solicitar-asistencia" class="fixed z-50 left-4 top-4 md:left-8 md:top-8 px-4 py-2 bg-blue-800 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-900 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-700 focus:ring-opacity-75">
        Solicitar Asistencia
    </button>
    <p id="assistance-message" class="text-center mt-4 text-sm font-medium fixed z-50 left-4 top-20 md:left-8 md:top-24"></p>


    <!-- Global Header with main navigation buttons (Centered above content cards) -->
    <div id="global-header-nav" class="w-full max-w-3xl mx-auto p-6 md:p-8 mb-8 bg-white rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Gestión de Currículums</h1>
        <div class="flex flex-col md:flex-row justify-center gap-4">
            <button id="btn-personal" class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Acceso del Personal
            </button>
            <button id="btn-rrhh" class="flex-1 px-6 py-3 bg-blue-100 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-blue-200 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-75">
                Acceso de Recursos Humanos
            </button>
        </div>
    </div>

    <!-- Personal Access Section (Main Container for sub-tabs) -->
    <div id="section-personal" class="section bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-3xl mx-auto border border-gray-100">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Acceso del Personal</h2>

        <!-- Sub-tabs for Personal Access -->
        <div class="mb-4 border-b border-gray-200">
            <nav class="flex flex-col md:flex-row justify-center gap-4" aria-label="Tabs">
                <button class="sub-tab-button text-gray-600 hover:text-gray-800 hover:border-gray-300 active" onclick="openPersonalSubTab(event, 'curriculumForm')">Formulario de Currículum</button>
                <button class="sub-tab-button text-gray-600 hover:text-gray-800 hover:border-gray-300 " onclick="openPersonalSubTab(event, 'habitualRouteDeclaration')">Declaración de Ruta Habitual</button>
                <button class="sub-tab-button text-gray-600 hover:text-gray-800 hover:border-gray-300" onclick="openPersonalSubTab(event, 'personal-sub-tab-instructions')">Instructivo</button>
            </nav>
        </div>

        <!-- Curriculum Form Sub-tab Content -->
        <div id="curriculumForm" class="personal-sub-tab-content active">
            <form id="curriculumFormContent" class="space-y-6">
                <!-- 1. Verificacion de personal -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">Verifica tu identidad para consultar tus datos</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="col-span-full">
                            <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                            <div class="flex flex-col sm:flex-row gap-2 mt-1">
                                <input type="email" id="email" name="email" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="ejemplo@dominio.com" required>
                                <button type="button" id="btn-send-code" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 whitespace-nowrap">Enviar Código</button>
                            </div>
                            <div id="email-verification-area" class="mt-2 hidden flex flex-col sm:flex-row gap-2">
                                <input type="text" id="verification-code" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Introduce el código">
                                <button type="button" id="btn-verify-code" class="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-md shadow-md hover:bg-blue-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 whitespace-nowrap">Verificar</button>
                            </div>
                            <p id="email-status" class="text-sm mt-1"></p>
                            <p id="resend-countdown" class="text-sm mt-1 text-gray-500 hidden">Puedes reenviar el código en <span id="countdown-timer" class="font-semibold">60</span> segundos.</p>
                        </div>
                        <div class="col-span-full">
                            <label for="cedula" class="block text-sm font-medium text-gray-700">Cédula</label>
                            <div class="flex gap-2 mt-1">
                                <input type="text" id="cedula" name="cedula" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="12345678" required>
                                <button type="button" id="btn-consult-cedula" class="px-4 py-2 bg-blue-700 text-white text-sm font-medium rounded-md hover:bg-blue-800 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-75 whitespace-nowrap">Consultar datos</button>
                            </div>
                            <p id="cedula-status" class="text-sm mt-1"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-3">
                        <div>
                            <label for="gerencia-general-display" class="block text-sm font-medium text-gray-700">Gerencia General</label>
                            <input type="text" id="gerencia-general-display" name="gerencia_general_display" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                            <input type="hidden" id="gerencia-general" name="gerencia_general">
                        </div>
                        <div>
                            <label for="gerencia-especifica-display" class="block text-sm font-medium text-gray-700">Gerencia Específica</label>
                            <input type="text" id="gerencia-especifica-display" name="gerencia_especifica_display" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                            <input type="hidden" id="gerencia-especifica" name="gerencia_especifica">
                        </div>
                        <div>
                            <label for="cargo-display" class="block text-sm font-medium text-gray-700">Cargo</label>
                            <input type="text" id="cargo-display" name="cargo-display" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" readonly>
                            <input type="hidden" id="cargo" name="cargo">
                        </div>
                    </div>
                </div>

                <!-- 1. Información Personal y Contacto -->
                <div class="bg-white p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">1. Información Personal y Contacto</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nombres" class="block text-sm font-medium text-gray-700">Nombres</label>
                            <input type="text" id="nombres" name="nombres" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="apellidos" class="block text-sm font-medium text-gray-700">Apellidos</label>
                            <input type="text" id="apellidos" name="apellidos" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="nacionalidad" class="block text-sm font-medium text-gray-700">Nacionalidad</label>
                            <select id="nacionalidad" name="nacionalidad" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                                <option value="V">Venezolana (V)</option>
                                <option value="E">Extranjera (E)</option>
                            </select>
                        </div>
                        <div>
                            <label for="lugar_nacimiento" class="block text-sm font-medium text-gray-700">Lugar de Nacimiento</label>
                            <input type="text" id="lugar_nacimiento" name="lugar_nacimiento" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="fecha_nacimiento" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                            <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="edad" class="block text-sm font-medium text-gray-700">Edad</label>
                            <input type="text" id="edad" name="edad" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                        </div>
                        <div>
                            <label for="estado_civil" class="block text-sm font-medium text-gray-700">Estado Civil</label>
                            <select id="estado_civil" name="estado_civil" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                                <option value="Soltero">Soltero/a</option>
                                <option value="Casado">Casado/a</option>
                                <option value="Divorciado">Divorciado/a</option>
                                <option value="Viudo">Viudo/a</option>
                                <option value="Union_Libre">Unión Libre</option>
                            </select>
                        </div>
                        <div>
                            <label for="sexo" class="block text-sm font-medium text-gray-700">Sexo</label>
                            <select id="sexo" name="sexo" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Femenino">Femenino</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div>
                            <label for="mano_dominante" class="block text-sm font-medium text-gray-700">Mano Dominante</label>
                            <select id="mano_dominante" name="mano_dominante" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                                <option value="Derecha">Derecha</option>
                                <option value="Izquierda">Izquierda</option>
                                <option value="Ambidiestro">Ambidiestro</option>
                            </select>
                        </div>
                        <div>
                            <label for="num_hijos" class="block text-sm font-medium text-gray-700">Número de Hijos</label>
                            <input type="number" id="num_hijos" name="num_hijos" min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="0">
                        </div>
                        <div id="children-ages-container" class="col-span-full grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Children age fields will be dynamically added here -->
                        </div>
                        <div>
                            <label for="telefono_habitacion" class="block text-sm font-medium text-gray-700">Teléfono de Habitación</label>
                            <input type="text" id="telefono_habitacion" name="telefono_habitacion" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="telefono_personal" class="block text-sm font-medium text-gray-700">Teléfono Personal (Móvil)</label>
                            <input type="text" id="telefono_personal" name="telefono_personal" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                        <div class="col-span-full">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Teléfonos de Emergencia</h4>
                            <div id="emergency-contacts-container" class="space-y-3">
                                <!-- Emergency contact fields will be dynamically added here -->
                            </div>
                            <button type="button" id="add-emergency-contact" class="mt-3 px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 transition duration-300">
                                + Añadir Teléfono de Emergencia
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 2. Dirección de Domicilio -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">2. Dirección de Domicilio</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="localidad" class="block text-sm font-medium text-gray-700">Localidad</label>
                            <select id="localidad" name="localidad" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>

                            <div id="nombre-localidad-container" class="mt-2" style="display:none;">
                                <label for="nombre-localidad" class="block text-sm font-medium text-gray-700">Nombre de la localidad</label>
                                <input type="text" id="nombre-localidad" name="nombre_localidad" class="mt-1 block w-full border rounded px-2 py-1" placeholder="Ingrese el nombre de la localidad">
                            </div>

                        <div>
                            <label for="inmueble" class="block text-sm font-medium text-gray-700">Tipo de Inmueble</label>
                            <select id="inmueble" name="inmueble" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div id="inmueble-specific-fields" class="col-span-full grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Dynamic fields based on inmueble type -->
                        </div>
                        <div>
                            <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                            <select id="estado" name="estado" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label for="ciudad" class="block text-sm font-medium text-gray-700">Ciudad o Pueblo</label>
                            <select id="ciudad" name="ciudad" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label for="municipio" class="block text-sm font-medium text-gray-700">Municipio</label>
                            <select id="municipio" name="municipio" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label for="parroquia" class="block text-sm font-medium text-gray-700">Parroquia</label>
                            <select id="parroquia" name="parroquia" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label for="zona_postal" class="block text-sm font-medium text-gray-700">Zona Postal</label>
                            <input type="text" id="zona_postal" name="zona_postal" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 1010" required>
                        </div>
                        <div class="col-span-full bg-blue-100 p-3 rounded-md text-gray-800 text-sm italic">
                            <span class="font-semibold">Vista Previa de Dirección:</span> <span id="address-preview"></span>
                        </div>
                        <div class="col-span-full">
                            <label for="condicion_habitacion" class="block text-sm font-medium text-gray-700">Condición de Habitación</label>
                            <select id="condicion_habitacion" name="condicion_habitacion" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione...</option>
                                <option value="Propia">Propia</option>
                                <option value="Alquilada">Alquilada</option>
                                <option value="Hipoteca">Hipoteca</option>
                                <option value="Familiar">Familiar</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 4. Medidas físicas para uniforme -->
                <div class="bg-white p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">3. Tallaje para Uniforme</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <label for="talla_camisa" class="block text-sm font-medium text-gray-700">Talla de Camisa</label>
                            <input type="text" id="talla_camisa" name="talla_camisa" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: S, M, L, XL">
                        </div>
                        <div>
                            <label for="talla_pantalon" class="block text-sm font-medium text-gray-700">Talla de Pantalón</label>
                            <input type="text" id="talla_pantalon" name="talla_pantalon" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 32, 34">
                        </div>
                        <div>
                            <label for="talla_calzado" class="block text-sm font-medium text-gray-700">Talla de Calzado</label>
                            <input type="text" id="talla_calzado" name="talla_calzado" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 40, 42">
                        </div>
                    </div>
                </div>

                <!-- 5. Estudios de Postgrado y Pregrado -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">4. Estudios de Postgrado y Pregrado</h4>
                    <div class="mb-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="esta-estudiando-actualmente" name="esta_estudiando_actualmente" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            <span class="ml-2 text-gray-700">¿Está estudiando actualmente?</span>
                        </label>
                    </div>
                    <div id="estudio-actual-fields" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="carrera-actual" class="block text-sm font-medium text-gray-700">Nombre de la Carrera Actual</label>
                            <input type="text" id="carrera-actual" name="carrera_actual" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="ano-actual" class="block text-sm font-medium text-gray-700">Año Actual</label>
                            <select id="ano-actual" name="ano_actual" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="">Seleccione...</option>
                                <option value="1er Año">1er Año</option>
                                <option value="2do Año">2do Año</option>
                                <option value="3er Año">3er Año</option>
                                <option value="4to Año">4to Año</option>
                                <option value="5to Año">5to Año</option>
                                <option value="1er Semestre">1er Semestre</option>
                                <option value="2do Semestre">2do Semestre</option>
                                <option value="3er Semestre">3er Semestre</option>
                                <option value="4to Semestre">4to Semestre</option>
                                <option value="5to Semestre">5to Semestre</option>
                                <option value="6to Semestre">6to Semestre</option>
                                <option value="7mo Semestre">7mo Semestre</option>
                                <option value="8vo Semestre">8vo Semestre</option>
                                <option value="9no Semestre">9no Semestre</option>
                                <option value="10mo Semestre">10mo Semestre</option>
                            </select>
                        </div>
                        <div>
                            <label for="turno-estudio" class="block text-sm font-medium text-gray-700">Turno de Estudio</label>
                            <select id="turno-estudio" name="turno_estudio" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="">Seleccione...</option>
                                <option value="Matutino">Matutino</option>
                                <option value="Vespertino">Vespertino</option>
                                <option value="Nocturno">Nocturno</option>
                                <option value="Sabatinos">Sabatinos</option>
                            </select>
                        </div>
                    </div>

                    <h4 class="text-lg font-semibold text-blue-800 mb-3 mt-6">Estudios de Pregrado (Títulos Obtenidos)</h4>
                    <div id="pregrado-fields-container" class="space-y-4">
                        <!-- Pregrado fields will be added here by JavaScript -->
                    </div>
                    <button type="button" id="add-pregrado" class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        + Añadir Título de Pregrado
                    </button>

                    <h4 class="text-lg font-semibold text-blue-800 mb-3 mt-6">Estudios de Postgrado (Títulos Obtenidos)</h4>
                    <div id="posgrado-fields-container" class="space-y-4">
                        <!-- Posgrado fields will be added here by JavaScript -->
                    </div>
                    <button type="button" id="add-posgrado" class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        + Añadir Título de Postgrado
                    </button>
                </div>

                <!-- 6. Experiencia Laboral -->
                <div class="bg-white p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">5. Experiencia Laboral (Comience con el más reciente o actual)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="col-span-full">
                            <label for="profesion" class="block text-sm font-medium text-gray-700">Profesión</label>
                            <input type="text" id="profesion" name="profesion" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold text-blue-800 mb-3">Historial Laboral</h4>
                    <div id="experience-fields-container" class="space-y-4">
                        <!-- Experience fields will be added here by JavaScript -->
                    </div>
                    <button type="button" id="add-experience" class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        + Añadir Experiencia
                    </button>
                </div>

                <!-- 7. Cursos, Idiomas, Habilidades y Destrezas -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">6. Cursos, Idiomas, Habilidades y Destrezas</h4>

                    <h4 class="text-lg font-semibold text-blue-800 mb-3 mt-6">Cursos Realizados</h4>
                    <div id="courses-fields-container" class="space-y-4">
                        <!-- Course fields will be added here by JavaScript -->
                    </div>
                    <button type="button" id="add-course" class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        + Añadir Curso
                    </button>

                    <h4 class="text-lg font-semibold text-blue-800 mb-3 mt-6">Idiomas</h4>
                    <div id="languages-fields-container" class="space-y-4">
                        <!-- Language fields will be added here by JavaScript -->
                    </div>
                    
                    <button type="button" id="add-language" class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        + Añadir Idioma
                    </button>

                    <h4 class="text-lg font-semibold text-blue-800 mb-3 mt-6">Habilidades y Destrezas</h4>
                    <div id="skills-fields-container" class="space-y-4">
                        <!-- Skills fields will be added here by JavaScript -->
                    </div>
                    <button type="button" id="add-skill" class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        + Añadir Habilidad/Destreza
                    </button>

                    <h4 class="text-lg font-semibold text-blue-800 mb-3 mt-6">Información de Salud (Opcional)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="col-span-full">
                            <label for="impedimento_medico_fisico" class="block text-sm font-medium text-gray-700">Impedimento Médico o Físico</label>
                            <textarea id="impedimento_medico_fisico" name="impedimento_medico_fisico" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Describa cualquier impedimento médico o físico"></textarea>
                        </div>
                    </div>
                </div>
                    
                <!-- 8. Referencias Personales -->
                <div class="bg-white p-6 rounded-lg shadow-inner mt-6">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">7. Referencias Personales</h4>
                    <div id="references-fields-container" class="space-y-4"></div>
                    <button type="button" id="add-reference" class="mt-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        + Añadir Referencia
                    </button>
                    <p id="references-warning" class="text-sm mt-2 text-red-600 hidden">Debe ingresar al menos 2 referencias personales.</p>
                </div>

                <!-- Campo Cargo Propuesto (solo visible si hay sesión) -->
                <div id="proposed-position-container" class="mt-6 hidden">
                    <label for="proposed-position" class="block text-sm font-medium text-gray-700">Cargo Propuesto</label>
                    <input type="text" id="proposed-position" name="cargo_propuesto" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- Submit and Cancel Buttons -->
                <div class="flex justify-center mt-8 gap-4">
                    <button type="submit" class="px-8 py-3 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-gray-400 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                        Guardar Cambios
                  f  </button>
                    <button type="button" id="cancel-form-btn" class="px-8 py-3 bg-gray-300 text-gray-800 font-bold text-lg rounded-lg shadow-xl hover:bg-gray-400 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                        Cancelar
                    </button>
                </div>
            </form>
            <p id="form-message" class="text-center mt-4 text-lg font-medium"></p>
        </div>

        <!-- Declaración de Ruta Habitual Sub-tab Content -->
        <div id="habitualRouteDeclaration" class="personal-sub-tab-content rounded-lg hidden">
            <form id="habitualRouteForm" class="space-y-6">
                <p id="ruta-form-message" class="text-center mt-4 text-lg font-medium"></p>
                <!-- Paso 1: Verificación de identidad para Declaración de Ruta Habitual -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">Verifica tu identidad para consultar tus datos</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="col-span-full">
                            <label for="ruta-email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                            <div class="flex flex-col sm:flex-row gap-2 mt-1">
                                <input type="email" id="ruta-email" name="ruta_email" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="ejemplo@dominio.com" required>
                                <button type="button" id="btn-send-ruta-code" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-md hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 whitespace-nowrap">Enviar Código</button>
                            </div>
                            <div id="ruta-email-verification-area" class="mt-2 hidden flex flex-col sm:flex-row gap-2">
                                <input type="text" id="ruta-verification-code" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Introduce el código">
                                <button type="button" id="btn-verify-ruta-code" class="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-md shadow-md hover:bg-blue-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 whitespace-nowrap">Verificar</button>
                            </div>
                            <p id="ruta-email-status" class="text-sm mt-1"></p>
                            <p id="ruta-resend-countdown" class="text-sm mt-1 text-gray-500 hidden">Puedes reenviar el código en <span id="ruta-countdown-timer" class="font-semibold">60</span> segundos.</p>
                        </div>
                        <div class="col-span-full">
                            <label for="ruta-cedula" class="block text-sm font-medium text-gray-700">Cédula</label>
                            <div class="flex gap-2 mt-1">
                                <input type="text" id="ruta-cedula" name="ruta_cedula" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="12345678" required>
                                <button type="button" id="btn-consult-ruta-cedula" class="px-4 py-2 bg-blue-700 text-white text-sm font-medium rounded-md hover:bg-blue-800 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-75 whitespace-nowrap">Consultar datos</button>
                            </div>
                            <p id="ruta-cedula-status" class="text-sm mt-1"></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="ruta-nombres" class="block text-sm font-medium text-gray-700">Nombres</label>
                            <input type="text" id="ruta-nombres" name="ruta_nombres"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                required>
                        </div>
                        <div>
                            <label for="ruta-apellidos" class="block text-sm font-medium text-gray-700">Apellidos</label>
                            <input type="text" id="ruta-apellidos" name="ruta_apellidos"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                required>
                        </div>
                    </div>
                </div>

                <!-- 2. Medios de Transporte (Ida) (blanco) -->
                <div class="bg-white p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">2. Medio(s) de Transporte (Ida)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_ida" value="Vehículo Propio" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Vehículo Propio</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_ida" value="Transporte Empresa" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Transporte Empresa</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_ida" value="Taxi" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Taxi</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_ida" value="Transporte Público" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Transporte Público</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_ida" value="Caminando" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Caminando</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_ida" value="Moto" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Moto</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_ida" value="Otro" class="form-checkbox h-5 w-5 text-blue-600 rounded" id="transporte-ida-otro-check"> <span class="ml-2">Otro (Indique)</span></label>
                        <input type="text" id="transporte-ida-otro" name="transporte_ida_otro"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm hidden"
                            placeholder="Especifique otro medio">
                    </div>
                </div>

                <!-- 3. Descripción de la Ruta Habitual (Ida) (azul) -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">3. Describa la Ruta Habitual (Ida)</h4>
                    <textarea id="ruta-descripcion-ida" name="ruta_descripcion_ida" rows="4"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        placeholder="Describa detalladamente la ruta habitual de acceso desde su vivienda hacia su lugar de trabajo. Incluya vías alternas y paradas."></textarea>
                </div>

                <!-- 4. Ruta Alterna (blanco) -->
                <div class="bg-white p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">4. ¿Existe alguna ruta alterna?</h4>
                    <div class="flex items-center gap-6 mb-2">
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="radio" name="ruta_alterna" value="SI" class="form-radio h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Sí</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="radio" name="ruta_alterna" value="NO" class="form-radio h-5 w-5 text-blue-600 rounded"> <span class="ml-2">No</span></label>
                    </div>
                    <textarea id="ruta-alterna-descripcion" name="ruta_alterna_descripcion" rows="3"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm hidden"
                        placeholder="Explique la ruta alterna si existe."></textarea>
                </div>

                <!-- 5. Hora de Salida (azul) -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">5. Hora de Salida (Ida)</h4>
                    <input type="time" id="hora-salida-ida" name="hora_salida_ida"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        required>
                </div>

                <!-- 6. Medios de Transporte (Regreso) (blanco) -->
                <div class="bg-white p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">6. Medio(s) de Transporte (Regreso)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_regreso" value="Vehículo Propio" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Vehículo Propio</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_regreso" value="Transporte Empresa" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Transporte Empresa</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_regreso" value="Taxi" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Taxi</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_regreso" value="Transporte Público" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Transporte Público</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_regreso" value="Caminando" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Caminando</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_regreso" value="Moto" class="form-checkbox h-5 w-5 text-blue-600 rounded"> <span class="ml-2">Moto</span></label>
                        <label class="inline-flex items-center text-sm font-medium text-gray-700"><input type="checkbox" name="transporte_regreso" value="Otro" class="form-checkbox h-5 w-5 text-blue-600 rounded" id="transporte-regreso-otro-check"> <span class="ml-2">Otro (Indique)</span></label>
                        <input type="text" id="transporte-regreso-otro" name="transporte_regreso_otro"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm hidden"
                            placeholder="Especifique otro medio">
                    </div>
                </div>

                <!-- 7. Descripción de la Ruta Habitual (Regreso) (azul) -->
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <h4 class="text-xl font-semibold text-blue-900 mb-4">7. Describa la Ruta Habitual (Regreso)</h4>
                    <textarea id="ruta-descripcion-regreso" name="ruta_descripcion_regreso" rows="4"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        placeholder="Describa detalladamente la ruta habitual de acceso desde su trabajo hasta su vivienda."></textarea>
                </div>

                <div class="flex justify-center mt-8">
                    <button type="submit"
                        class="px-8 py-3 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-blue-700 transition">Guardar Declaración</button>
                </div>
            </form>
        </div>

        <div id="personal-sub-tab-instructions" class="personal-sub-tab-content">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Instructivo de Uso</h2>

            <div class="bg-gray-50 p-6 rounded-lg shadow mb-8">
                <h3 class="text-2xl font-semibold text-blue-700 mb-4">Uso del Formulario de Currículum</h3>
                <p class="mb-3 text-gray-700">Aquí encontrarás los pasos para llenar tu información de currículum.</p>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>Sección de Datos Personales:</strong> Completa todos los campos con tu información personal (cédula, nombres, apellidos, fecha de nacimiento, etc.).</li>
                    <li><strong>Formación Académica:</strong> Agrega cada grado o título obtenido, comenzando por el más reciente. Indica la institución y el periodo.</li>
                    <li><strong>Experiencia Laboral:</strong> Detalla tus empleos anteriores, incluyendo el nombre de la empresa, cargo, fechas de inicio y fin, y una descripción concisa de tus responsabilidades y logros clave.</li>
                    <li><strong>Habilidades e Idiomas:</strong> Enumera tus habilidades relevantes para el puesto y los idiomas que dominas, indicando tu nivel de fluidez (básico, intermedio, avanzado, nativo).</li>
                    <li><strong>Referencias Personales:</strong> Proporciona los datos de contacto (nombre, relación, teléfono) de al menos dos personas que puedan dar fe de tu trayectoria laboral o personal.</li>
                    <li><strong>Teléfonos de Emergencia:</strong> Ingresa los contactos a quienes se debe notificar en caso de una emergencia.</li>
                    <li><strong>Botón "Guardar":</strong> Asegúrate de hacer clic en el botón "Guardar" al final del formulario de Currículum para guardar todos los cambios.</li>
                </ul>
            </div>

            <div class="bg-gray-50 p-6 rounded-lg shadow">
                <h3 class="text-2xl font-semibold text-blue-700 mb-4">Uso del Formulario de Declaración de Ruta Habitual</h3>
                <p class="mb-3 text-gray-700">Este formulario es para registrar tu ruta diaria desde tu hogar hasta tu lugar de trabajo y viceversa.</p>
                <ul class="list-disc list-inside text-gray-700 space-y-2">
                    <li><strong>Cédula del Empleado:</strong> Ingresa tu número de cédula en el campo correspondiente. Esto cargará automáticamente tu nombre y apellido si ya estás registrado.</li>
                    <li><strong>Origen (Ida):</strong> Describe detalladamente el punto de inicio de tu ruta diaria de ida (ej. "Desde mi casa en la urbanización Los Naranjos").</li>
                    <li><strong>Destino (Ida):</strong> Describe el punto final de tu ruta diaria de ida (ej. "Hasta la oficina principal en el centro").</li>
                    <li><strong>Medio(s) de Transporte (Ida):</strong> Selecciona todos los medios de transporte que utilizas para ir al trabajo. Si tu medio no está en la lista, selecciona "Otro" y especifica cuál es.</li>
                    <li><strong>Hora de Salida (Ida):</strong> Indica la hora aproximada a la que usualmente sales de tu casa para ir al trabajo (ej. "07:30 AM").</li>
                    <li><strong>Medio(s) de Transporte (Regreso):</strong> Selecciona los medios de transporte que utilizas para regresar a casa. Si tu medio no está en la lista, selecciona "Otro" y especifica.</li>
                    <li><strong>Hora de Salida (Regreso):</strong> Indica la hora aproximada a la que usualmente sales del trabajo para regresar a casa (ej. "05:00 PM").</li>
                    <li><strong>Ruta Alterna:</strong> Si tienes una ruta alternativa que usarías en caso de emergencia o interrupción de tu ruta habitual, selecciona "Sí" y proporciona una descripción detallada de esta ruta.</li>
                    <li><strong>Botón "Guardar Declaración":</strong> Una vez que hayas completado todos los campos, haz clic en este botón para guardar tu declaración de ruta. Recibirás un mensaje de confirmación.</li>
                </ul>
            </div>
        </div>
    </div>
        
        </div>
    </div>

    <!-- HR Login Section - Rendered as a centered card -->
    <div id="section-login" class="section hidden bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-3xl mx-auto border border-gray-100">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Acceso de Recursos Humanos</h2>
        <div class="bg-blue-50 p-6 rounded-lg shadow-inner max-w-md mx-auto">
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-cedula" class="block text-sm font-medium text-gray-700">Cédula de Usuario</label>
                    <input type="text" id="login-cedula" name="login_cedula" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Cédula" required>
                </div>
                <div>
                    <label for="login-clave" class="block text-sm font-medium text-gray-700">Clave</label>
                    <input type="password" id="login-clave" name="login_clave" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contraseña" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                    Ingresar
                </button>
                <div class="flex flex-col items-center mt-4 gap-2">
                    <button type="button" id="btn-recuperar-usuario" class="text-blue-700 hover:underline text-sm">¿Olvidó su usuario?</button>
                    <button type="button" id="btn-recuperar-clave" class="text-blue-700 hover:underline text-sm">¿Olvidó su clave?</button>
                </div>
                <div id="recuperacion-message" class="text-center mt-2 text-sm font-medium"></div>
            </form>
            <p id="login-message" class="text-center mt-4 text-sm font-medium"></p>
        </div>

        <!-- Puedes agregar esto cerca del login-form -->
        <div id="recuperacion-modal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                <h3 id="recuperacion-titulo" class="text-lg font-semibold text-blue-800 mb-4"></h3>
                <label for="recuperacion-cedula" class="block text-sm font-medium text-gray-700">Cédula</label>
                <input type="text" id="recuperacion-cedula" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="12345678">
                <label for="recuperacion-email" class="block text-sm font-medium text-gray-700 mt-2">Correo electrónico registrado</label>
                <input type="email" id="recuperacion-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="ejemplo@dominio.com">
                <label for="recuperacion-usuario" id="recuperacion-usuario-label" class="block text-sm font-medium text-gray-700 mt-2 hidden">Usuario</label>
                <input type="text" id="recuperacion-usuario" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm hidden" placeholder="Usuario" autocomplete="username">
                
                <!-- Nuevo campo para el código de verificación -->
                <label for="recuperacion-codigo" id="recuperacion-codigo-label" class="block text-sm font-medium text-gray-700 mt-2 hidden">Código de verificación</label>
                <input type="text" id="recuperacion-codigo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm hidden" placeholder="Ingrese el código recibido">

                <button id="btn-enviar-recuperacion" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">Enviar código de recuperación</button>
                <button id="btn-validar-codigo" class="mt-2 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition hidden">Validar código y generar clave temporal</button>
                <button id="btn-cerrar-recuperacion" class="mt-2 w-full px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition">Cancelar</button>
                <p id="recuperacion-modal-message" class="text-center mt-2 text-sm font-medium"></p>
            </div>
        </div>
    </div>
    </div>

    <!-- HR Main Layout Container (Flex container for menu and content) -->
    <div id="hr-main-layout" class="section hidden w-full h-full min-h-[calc(100vh-10rem)]">

        <!-- Left Sliding Menu Panel (HR Navigation) -->
        <div id="hr-menu-panel">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Menú RRHH</h3>
                <button id="close-menu-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
            </div>
            <nav class="flex-grow space-y-4">
                <button id="menu-show-dashboard-button" class="w-full text-left px-4 py-2 bg-blue-700 text-white font-semibold rounded-lg shadow-md hover:bg-blue-800 transition duration-300">
                    Ver Dashboard
                </button>
                <button id="menu-show-employee-list-button" class="w-full text-left px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                    Lista de Empleados
                </button>
                <button id="menu-show-survey-status-button" class="w-full text-left px-4 py-2 bg-blue-800 text-white font-semibold rounded-lg shadow-md hover:bg-blue-900 transition duration-300">
                    Estado Encuesta
                </button>
                <button id="menu-show-precarga-button" class="w-full text-left px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300">
                    Pre-carga de Personal
                </button>
                <!-- NEW: Database Options Button -->
                <button id="menu-show-database-button" class="w-full text-left px-4 py-2 bg-blue-900 text-white font-semibold rounded-lg shadow-md hover:bg-blue-950 transition duration-300">
                    Base de Datos
                </button>
            </nav>
            <div class="mt-auto pt-6 border-t border-gray-200">
                <button id="menu-logout-button" class="w-full text-left px-4 py-2 bg-blue-800 text-white font-semibold rounded-lg shadow-md hover:bg-blue-900 transition duration-300">
                    Cerrar Sesión
                </button>
            </div>
        </div>

        <!-- Main HR Content Area (This div will expand/shrink) -->
        <div id="hr-content-area" class="flex-grow p-6 md:p-8 bg-white rounded-xl shadow-2xl border border-gray-100 transition-all duration-300 ease-in-out">
            <!-- ALL HR SECTIONS ARE NOW CONTAINED HERE AND TOGGLED WITH 'hr-section' class -->

            <!-- HR View Section (Employee List - default view for HR) -->
            <div id="section-rrhh-content" class="hr-section">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Lista de Empleados</h2>
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <p id="rrhh-status-message" class="text-center text-blue-600 text-lg mb-4"></p>
                    
                    <!-- Employee List Table -->
                    <div id="employee-list-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cédula</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nombres</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Apellidos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Gerencia General</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Gerencia Específica</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cargo</th>
                                </tr>
                            </thead>
                            <tbody id="employee-table-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Cargando datos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            
            <!-- Dashboard Section -->
            <div id="section-dashboard-content" class="hr-section hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Dashboard de Monitoreo RRHH</h2>
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <div class="flex flex-col md:flex-row justify-end items-center mb-4 gap-2">
                        <button id="download-employee-report-button" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                            Descargar Reporte de Empleados (CSV)
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <!-- Total Count Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Totales</h3>
                            <canvas id="total-chart"></canvas>
                            <p class="text-sm text-gray-600 mt-2 text-center">
                                Total de Formularios Llenados: <span id="filled-forms-count" class="font-bold">0</span><br>
                                Total de Personal Registrado: <span id="total-personnel-count" class="font-bold">0</span>
                            </p>
                        </div>

                        <!-- Education by General Management Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Nivel Educativo por Gerencia General</h3>
                            <canvas id="education-gerencia-chart"></canvas>
                        </div>

                        <!-- Education by Job Title Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Nivel Educativo por Cargo</h3>
                            <canvas id="education-cargo-chart"></canvas>
                        </div>

                        <!-- NEW CHARTS ADDED BELOW -->

                        <!-- Gender Distribution Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Distribución por Género</h3>
                            <canvas id="gender-distribution-chart"></canvas>
                        </div>

                        <!-- Marital Status Distribution Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Distribución por Estado Civil</h3>
                            <canvas id="marital-status-chart"></canvas>
                        </div>

                        <!-- Nationality Distribution Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Distribución por Nacionalidad</h3>
                            <canvas id="nationality-distribution-chart"></canvas>
                        </div>
                        
                        <!-- Experience Overview Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Visión General de Experiencia Laboral</h3>
                            <canvas id="experience-overview-chart"></canvas>
                        </div>

                        <!-- Languages by Level Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Idiomas por Nivel</h3>
                            <canvas id="languages-by-level-chart"></canvas>
                        </div>

                        <!-- Skills Overview Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Habilidades Registradas</h3>
                            <canvas id="skills-overview-chart"></canvas>
                        </div>

                        <!-- Courses by General Management Chart -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3 text-center">Personas con Cursos por Gerencia General</h3>
                            <canvas id="courses-gerencia-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Survey Status Section -->
            <div id="section-survey-status-content" class="hr-section hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Estado de Encuesta de Personal</h2>
            <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
                    <button id="download-survey-report-button" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                        Descargar Reporte de Encuestas (CSV)
                    </button>
                    <div class="flex gap-2">
                        <input type="text" id="survey-cedula-search" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Buscar por Cédula (12345678)">
                        <button id="btn-search-survey-status" class="px-4 py-2 bg-blue-700 text-white text-sm font-medium rounded-md hover:bg-blue-800 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-75 whitespace-nowrap">Buscar</button>
                        <button id="btn-clear-survey-search" class="px-4 py-2 bg-blue-400 text-white text-sm font-medium rounded-md hover:bg-blue-500 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-75 whitespace-nowrap">Limpiar</button>
                    </div>
                </div>
                <div class="mb-4 flex justify-center gap-4">
                    <button id="btn-survey-completed" class="sub-tab-button active">Realizados</button>
                    <button id="btn-survey-pending" class="sub-tab-button">Pendientes</button>
                </div>
                <div id="survey-completed-tab" class="sub-tab-content active">
                    <p id="survey-completed-message" class="text-center text-blue-600 text-lg mb-4"></p>
                    <div id="survey-completed-list-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cédula</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nombres</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Apellidos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Gerencia General</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cargo</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Estado Encuesta</th>
                                </tr>
                            </thead>
                            <tbody id="survey-completed-table-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Cargando estado de encuestas...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="survey-pending-tab" class="sub-tab-content hidden">
                    <p id="survey-pending-message" class="text-center text-blue-600 text-lg mb-4"></p>
                    <div id="survey-pending-list-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cédula</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nombres</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Apellidos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Gerencia General</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cargo</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Estado Encuesta</th>
                                </tr>
                            </thead>
                            <tbody id="survey-pending-table-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Cargando estado de encuestas...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

            <!-- Removed Form Progress Section -->
            <!-- <div id="section-form-progress-content" class="hr-section hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Progreso de Formularios del Personal</h2>
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                    <p id="form-progress-message" class="text-center text-blue-600 text-lg mb-4"></p>
                    <div id="form-progress-list-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cédula</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Nombres</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Apellidos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Gerencia General</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cargo</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Progreso</th>
                                </tr>
                            </thead>
                            <tbody id="form-progress-table-body" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Cargando progreso de formularios...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> -->

            <!-- NEW: Database Management Section -->
            <div id="section-database-content" class="hr-section hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Gestión de Base de Datos</h2>
                <div class="bg-blue-50 p-6 rounded-lg shadow-inner space-y-8">
                    <!-- Export Data Section -->
                    <div>
                        <h3 class="text-xl font-semibold text-blue-900 mb-4">Exportar Datos</h3>
                        <p class="text-gray-700 mb-4">Seleccione la tabla que desea exportar como archivo CSV.</p>
                        <div class="flex flex-col md:flex-row gap-4 items-center">
                            <label for="export-table-select" class="block text-sm font-medium text-gray-700 whitespace-nowrap">Tabla a Exportar:</label>
                            <select id="export-table-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="">-- Seleccione una tabla --</option>
                                <option value="empleados">Empleados</option>
                                <option value="direcciones">Direcciones</option>
                                <option value="educacion">Educación</option>
                                <option value="experiencia_laboral">Experiencia Laboral</option>
                                <option value="cursos">Cursos</option>
                                <option value="idiomas">Idiomas</option>
                                <option value="habilidades">Habilidades</option>
                                <option value="usuarios">Usuarios</option>
                                <option value="realizados">Realizados</option>
                                <option value="cargos">Cargos</option>
                                <option value="gerencias_generales">Gerencias Generales</option>
                                <option value="gerencias_especificas">Gerencias Especificas</option>
                                <option value="solicitudes_asistencia">Solicitudes Asistencia</option>
                                <option value="ubicaciones_localidad">Ubicaciones Localidad</option>
                                <option value="ubicaciones_inmueble">Ubicaciones Inmueble</option>
                                <option value="ubicaciones_estados">Ubicaciones Estados</option>
                                <option value="ubicaciones_municipios">Ubicaciones Municipios</option>
                                <option value="ubicaciones_parroquias">Ubicaciones Parroquias</option>
                                <option value="ubicaciones_ciudades">Ubicaciones Ciudades</option>
                                <option value="todas">Todas las Tablas (Zip)</option>
                            </select>
                            <button id="export-selected-table-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300" disabled>
                                Exportar
                            </button>
                        </div>
                        <p id="export-message" class="text-sm mt-2 text-center"></p>
                    </div>

                    <hr class="border-gray-200">

                    <!-- Import Data Section -->
                    <div>
                        <h3 class="text-xl font-semibold text-blue-900 mb-4">Importar Datos desde CSV</h3>
                        <p class="text-gray-700 mb-4">Seleccione un archivo CSV para importar datos a la tabla elegida. Asegúrese de que el formato coincida con las plantillas.</p>
                        <div class="flex flex-col md:flex-row gap-4 items-center mb-4">
                            <label for="import-table-select" class="block text-sm font-medium text-gray-700 whitespace-nowrap">Tabla a Importar:</label>
                            <select id="import-table-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="">-- Seleccione una tabla --</option>
                                <option value="empleados">Empleados</option>
                                <option value="direcciones">Direcciones</option>
                                <option value="educacion">Educación</option>
                                <option value="experiencia_laboral">Experiencia Laboral</option>
                                <option value="cursos">Cursos</option>
                                <option value="idiomas">Idiomas</option>
                                <option value="habilidades">Habilidades</option>
                                <option value="usuarios">Usuarios</option>
                                <option value="realizados">Realizados</option>
                                <option value="cargos">Cargos</option>
                                <option value="gerencias_generales">Gerencias Generales</option>
                                <option value="gerencias_especificas">Gerencias Especificas</option>
                                <option value="solicitudes_asistencia">Solicitudes Asistencia</option>
                                <option value="ubicaciones_localidad">Ubicaciones Localidad</option>
                                <option value="ubicaciones_inmueble">Ubicaciones Inmueble</option>
                                <option value="ubicaciones_estados">Ubicaciones Estados</option>
                                <option value="ubicaciones_municipios">Ubicaciones Municipios</option>
                                <option value="ubicaciones_parroquias">Ubicaciones Parroquias</option>
                                <option value="ubicaciones_ciudades">Ubicaciones Ciudades</option>
                            </select>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-blue-100 p-4 rounded-lg">
                                <label for="import-file-input" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Archivo (.csv)</label>
                                <input type="file" id="import-file-input" accept=".csv" class="block w-full text-sm text-gray-500
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-md file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-blue-50 file:text-blue-700
                                    hover:file:bg-blue-100"/>
                                <button id="import-selected-table-btn" class="mt-3 px-4 py-2 bg-blue-700 text-white font-semibold rounded-lg shadow-md hover:bg-blue-800 transition duration-300" disabled>
                                    Importar Datos
                                </button>
                                <p id="import-message" class="text-sm mt-2"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Pre-carga de Personal Section -->
            <div id="section-precarga-content" class="hr-section hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Pre-carga de Personal Nuevo Ingreso</h2>
                <div class="bg-purple-50 p-6 rounded-lg shadow-inner">
                    <p class="text-gray-700 mb-4">Utilice este formulario para precargar la información básica de nuevos empleados antes de que completen su currículum.</p>
                    <form id="precarga-form" class="space-y-4">
                        <div>
                            <label for="precarga-cedula" class="block text-sm font-medium text-gray-700">Cédula</label>
                            <input type="text" id="precarga-cedula" name="precarga_cedula" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="12345678" required>
                        </div>
                        <div>
                            <label for="precarga-nombres" class="block text-sm font-medium text-gray-700">Nombres</label>
                            <input type="text" id="precarga-nombres" name="precarga_nombres" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="precarga-apellidos" class="block text-sm font-medium text-gray-700">Apellidos</label>
                            <input type="text" id="precarga-apellidos" name="precarga_apellidos" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="precarga-gerencia-general" class="block text-sm font-medium text-gray-700">Gerencia General</label>
                            <select id="precarga-gerencia-general" name="gerencia_general" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label for="precarga-gerencia-especifica" class="block text-sm font-medium text-gray-700">Gerencia Específica</label>
                            <select id="precarga-gerencia-especifica" name="gerencia_especifica" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div>
                            <label for="precarga-cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
                            <select id="precarga-cargo" name="cargo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300">
                            Guardar Pre-carga
                        </button>
                    </form>
                    <p id="precarga-message" class="text-center mt-4 text-sm font-medium"></p>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDK (will be used for future backend integration with Firestore) -->
     
    <script type="module">

        // Firebase no es utilizado directamente en este frontend, ya que el backend maneja la DB
        // y la autenticación. Se mantiene el bloque para posible uso futuro si el diseño cambia.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (provided by the Canvas environment) - not actively used in this frontend logic
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // Corrected initialAuthToken: Should reference __initial_auth_token itself, not a variable with the same name
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let app;
        let db;
        let auth;
        let userId = 'anon_user'; // Default anonymous user ID
        let isAuthReady = false;

        // URL BASE DEL BACKEND
        const BACKEND_URL = 'http://127.0.0.1:9502'; // Assuming Flask backend runs on port 9502

        // Initialize Firebase and set up authentication listener
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn('Firebase config is empty. Firestore will not be fully functional.');
                } else {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in with custom token if available, otherwise anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    // Listen for auth state changes and trigger UI update
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            userId = 'anon_user_' + crypto.randomUUID();
                        }
                        isAuthReady = true;
                        
                        // Get the ID of the currently active main tab button
                        const currentActiveTabButton = document.querySelector('#global-header-nav button.bg-blue-600');
                        let currentActiveTabName = 'personalAccess'; // Default to personal access if no button is active

                        if (currentActiveTabButton) {
                            if (currentActiveTabButton.id === 'btn-personal') {
                                currentActiveTabName = 'personalAccess';
                            } else if (currentActiveTabButton.id === 'btn-rrhh') {
                                currentActiveTabName = 'adminTools';
                            }
                        }
                        // Re-evaluate the UI based on the current active tab and the (possibly new) auth state
                        openTab(null, currentActiveTabName); // Pass null for event, it's not a user click
                    });
                }
            } catch (error) {
                console.error("Error initializing Firebase or during authentication:", error);
            }
        }

        // Call Firebase initialization when the window loads
        window.onload = initializeFirebase;

        // --- Data for Form Options (No hardcoded location data anymore) ---

        const gradoPregradoOptions = ["TSU", "Licenciado", "Ingeniero"];
        const gradoPosgradoOptions = ["Magister", "Doctorado", "Postdoctorado", "Diplomado"];
        const estadoCivilOptions = ["Soltero", "Casado", "Divorciado", "Viudo", "Unión Libre"];
        const sexoOptions = ["Masculino", "Femenino"];
        const manoDominanteOptions = ["Derecha", "Izquierda", "Ambidiestro"];
        const condicionHabitacionOptions = ["Propia", "Alquilada", "Hipoteca", "Familiar", "Otros"];
        const idiomaNivelOptions = ["A1", "A2", "B1", "B2", "C1", "C2"];

        // --- DOM Elements ---
        const btnPersonal = document.getElementById('btn-personal');
        const btnRrhh = document.getElementById('btn-rrhh');
        const sectionPersonal = document.getElementById('section-personal');
        const sectionLogin = document.getElementById('section-login'); 

        // Personal Access Sub-tabs
        const personalSubTabButtons = document.querySelectorAll('#section-personal .sub-tab-button');
        const curriculumFormSubTab = document.getElementById('curriculumForm');
        const habitualRouteDeclarationSubTab = document.getElementById('habitualRouteDeclaration');
        const InstructivoSubTab = document.getElementById('personal-sub-tab-instructions');

        // HR Specific Layout Elements
        const hrMainLayout = document.getElementById('hr-main-layout');
        const hrContentArea = document.getElementById('hr-content-area');
        // Specific HR sections inside hr-content-area
        const sectionRrhhContent = document.getElementById('section-rrhh-content');
        const sectionDashboardContent = document.getElementById('section-dashboard-content');
        const sectionSurveyStatusContent = document.getElementById('section-survey-status-content');
        const sectionDatabaseContent = document.getElementById('section-database-content');
        // NEW: Pre-carga de Personal section element
        const sectionPrecargaContent = document.getElementById('section-precarga-content');


        const curriculumFormContent = document.getElementById('curriculumFormContent'); // Changed ID to avoid conflict with sub-tab ID
        const formMessage = document.getElementById('form-message');

        const loginForm = document.getElementById('login-form');
        const loginCedulaInput = document.getElementById('login-cedula');
        const loginClaveInput = document.getElementById('login-clave');
        const loginMessage = document.getElementById('login-message');
        
        // Menu Toggle and Panel elements
        const menuToggle = document.getElementById('menu-toggle');
        const menuCountSpan = document.getElementById('menu-count');
        const notificationBell = document.getElementById('notification-bell');
        const notificationBellCountSpan = document.getElementById('notification-bell-count');
        const hrMenuPanel = document.getElementById('hr-menu-panel');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const menuShowEmployeeListButton = document.getElementById('menu-show-employee-list-button');
        const menuShowDashboardButton = document.getElementById('menu-show-dashboard-button');
        const menuShowSurveyStatusButton = document.getElementById('menu-show-survey-status-button');
        const menuShowDatabaseButton = document.getElementById('menu-show-database-button');
        // NEW: Pre-carga de Personal menu button
        const menuShowPrecargaButton = document.getElementById('menu-show-precarga-button');
        const menuLogoutButton = document.getElementById('menu-logout-button');

        // Floating Notification Popup elements
        const assistanceNotificationPopup = document.getElementById('assistance-notification-popup');
        const closeAssistancePopupBtn = document.getElementById('close-assistance-popup-btn');
        const popupStatusMessage = document.getElementById('popup-status-message');
        const pendingRequestsList = document.getElementById('pending-requests-list');

        const downloadEmployeeReportButton = document.getElementById('download-employee-report-button');
        const downloadSurveyReportButton = document.getElementById('download-survey-report-button');

        const rrhhStatusMessage = document.getElementById('rrhh-status-message');
        const employeeTableBody = document.getElementById('employee-table-body');
        
        const filledFormsCountSpan = document.getElementById('filled-forms-count');
        const totalPersonnelCountSpan = document.getElementById('total-personnel-count');

        const surveyCedulaSearchInput = document.getElementById('survey-cedula-search');
        const btnSearchSurveyStatus = document.getElementById('btn-search-survey-status');
        const btnClearSurveySearch = document.getElementById('btn-clear-survey-search');
        const surveyStatusMessage = document.getElementById('survey-status-message');
        const surveyStatusTableBody = document.getElementById('survey-status-table-body');

        // NEW Database section elements
        const exportTableSelect = document.getElementById('export-table-select');
        const exportSelectedTableBtn = document.getElementById('export-selected-table-btn');
        const exportMessage = document.getElementById('export-message');
        const importTableSelect = document.getElementById('import-table-select');
        const importFileInput = document.getElementById('import-file-input');
        const importSelectedTableBtn = document.getElementById('import-selected-table-btn');
        const importMessage = document.getElementById('import-message');

        // NEW: Pre-carga de Personal form elements
        const precargaForm = document.getElementById('precarga-form');
        const precargaCedulaInput = document.getElementById('precarga-cedula');
        const precargaNombresInput = document.getElementById('precarga-nombres');
        const precargaApellidosInput = document.getElementById('precarga-apellidos');
        const precargaMessage = document.getElementById('precarga-message');


        const cedulaInput = document.getElementById('cedula');
        const btnConsultCedula = document.getElementById('btn-consult-cedula');
        const cedulaStatus = document.getElementById('cedula-status');
        const nombresInput = document.getElementById('nombres');
        const apellidosInput = document.getElementById('apellidos');
        // New personal info fields
        const nacionalidadSelect = document.getElementById('nacionalidad');
        const lugarNacimientoInput = document.getElementById('lugar_nacimiento');
        const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
        const edadInput = document.getElementById('edad');
        const estadoCivilSelect = document.getElementById('estado_civil');
        const sexoSelect = document.getElementById('sexo');
        const manoDominanteSelect = document.getElementById('mano_dominante');
        const numHijosInput = document.getElementById('num_hijos');
        const childrenAgesContainer = document.getElementById('children-ages-container');
        const telefonoHabitacionInput = document.getElementById('telefono_habitacion');
        const telefonoPersonalInput = document.getElementById('telefono_personal');
        const emergencyContactsContainer = document.getElementById('emergency-contacts-container');
        const addEmergencyContactButton = document.getElementById('add-emergency-contact');
        const profesionInput = document.getElementById('profesion');
        const impedimentoMedicoFisicoTextarea = document.getElementById('impedimento_medico_fisico');
        const tallaCamisaInput = document.getElementById('talla_camisa');
        const tallaPantalonInput = document.getElementById('talla_pantalon');
        const tallaCalzadoInput = document.getElementById('talla_calzado');
        const condicionHabitacionSelect = document.getElementById('condicion_habitacion');


        // Display-only input fields for organizational info
        const gerenciaGeneralDisplay = document.getElementById('gerencia-general-display');
        const gerenciaGeneralHidden = document.getElementById('gerencia-general');
        const gerenciaEspecificaDisplay = document.getElementById('gerencia-especifica-display');
        const gerenciaEspecificaHidden = document.getElementById('gerencia-especifica');
        const cargoDisplay = document.getElementById('cargo-display');
        const cargoHidden = document.getElementById('cargo');

        const emailInput = document.getElementById('email');
        const btnSendCode = document.getElementById('btn-send-code');
        const emailVerificationArea = document.getElementById('email-verification-area');
        const verificationCodeInput = document.getElementById('verification-code');
        const btnVerifyCode = document.getElementById('btn-verify-code');
        const emailStatus = document.getElementById('email-status');
        const resendCountdownSpan = document.getElementById('resend-countdown');
        const countdownTimerSpan = document.getElementById('countdown-timer');
        const btnSolicitarAsistencia = document.getElementById('btn-solicitar-asistencia');
        const assistanceMessage = document.getElementById('assistance-message');


        // New Address Elements
        const localidadSelect = document.getElementById('localidad');
        const inmuebleSelect = document.getElementById('inmueble');
        const inmuebleSpecificFields = document.getElementById('inmueble-specific-fields');
        const zonaPostalInput = document.getElementById('zona_postal');
        const addressPreviewSpan = document.getElementById('address-preview');

        // Existing Address Elements (updated dependencies)
        const estadoSelect = document.getElementById('estado');
        const municipioSelect = document.getElementById('municipio');
        const parroquiaSelect = document.getElementById('parroquia');
        const ciudadSelect = document.getElementById('ciudad');
        // Removed direccionFiscalTextarea as it's replaced


        // NEW Education fields
        const estaEstudiandoCheckbox = document.getElementById('esta-estudiando-actualmente');
        const estudioActualFieldsDiv = document.getElementById('estudio-actual-fields');
        const carreraActualInput = document.getElementById('carrera-actual');
        const anoActualSelect = document.getElementById('ano-actual');
        const turnoEstudioSelect = document.getElementById('turno-estudio');

        // Separate containers and buttons for Pregrado and Posgrado
        const pregradoFieldsContainer = document.getElementById('pregrado-fields-container');
        const addPregradoButton = document.getElementById('add-pregrado');
        const posgradoFieldsContainer = document.getElementById('posgrado-fields-container');
        const addPosgradoButton = document.getElementById('add-posgrado');


        const experienceFieldsContainer = document.getElementById('experience-fields-container');
        const addExperienceButton = document.getElementById('add-experience');
        const coursesFieldsContainer = document.getElementById('courses-fields-container');
        const addCourseButton = document.getElementById('add-course');

        // New language and skills fields
        const languagesFieldsContainer = document.getElementById('languages-fields-container');
        const addLanguageButton = document.getElementById('add-language');
        const skillsFieldsContainer = document.getElementById('skills-fields-container');
        const addSkillButton = document.getElementById('add-skill');

        const btnRecuperarUsuario = document.getElementById('btn-recuperar-usuario');
        const btnRecuperarClave = document.getElementById('btn-recuperar-clave');
        const recuperacionModal = document.getElementById('recuperacion-modal');
        const recuperacionTitulo = document.getElementById('recuperacion-titulo');
        const recuperacionEmail = document.getElementById('recuperacion-email');
        const btnEnviarRecuperacion = document.getElementById('btn-enviar-recuperacion');
        const btnCerrarRecuperacion = document.getElementById('btn-cerrar-recuperacion');
        const recuperacionModalMessage = document.getElementById('recuperacion-modal-message');
        const recuperacionMessage = document.getElementById('recuperacion-message');
        const recuperacionCedula = document.getElementById('recuperacion-cedula');
        const recuperacionUsuario = document.getElementById('recuperacion-usuario');
        const recuperacionUsuarioLabel = document.getElementById('recuperacion-usuario-label');
        const recuperacionCodigoLabel = document.getElementById('recuperacion-codigo-label');
        const recuperacionCodigo = document.getElementById('recuperacion-codigo');
        const btnValidarCodigo = document.getElementById('btn-validar-codigo');

        let tipoRecuperacion = ''; // 'usuario' o 'clave'

        btnRecuperarUsuario.addEventListener('click', () => {
        tipoRecuperacion = 'usuario';
        recuperacionTitulo.textContent = 'Recuperar Usuario';
        recuperacionCedula.value = '';
        recuperacionEmail.value = '';
        recuperacionUsuario.value = '';
        recuperacionUsuario.classList.add('hidden');
        recuperacionUsuarioLabel.classList.add('hidden');
        recuperacionModalMessage.textContent = '';
        recuperacionModal.classList.remove('hidden');
    });

        btnRecuperarClave.addEventListener('click', () => {
            tipoRecuperacion = 'clave';
            recuperacionTitulo.textContent = 'Recuperar Clave';
            recuperacionCedula.value = '';
            recuperacionEmail.value = '';
            recuperacionUsuario.value = '';
            recuperacionUsuario.classList.remove('hidden');
            recuperacionUsuarioLabel.classList.remove('hidden');
            recuperacionModalMessage.textContent = '';
            recuperacionModal.classList.remove('hidden');
        });

        btnCerrarRecuperacion.addEventListener('click', () => {
            recuperacionModal.classList.add('hidden');
        });

        let recuperacionCountdownInterval;

        btnEnviarRecuperacion.addEventListener('click', async () => {
            const cedula = recuperacionCedula.value.trim();
            const email = recuperacionEmail.value.trim();
            const usuario = recuperacionUsuario.value.trim();
            recuperacionModalMessage.textContent = '';

            if (!cedula || !email || (tipoRecuperacion === 'clave' && !usuario)) {
                recuperacionModalMessage.textContent = 'Complete todos los campos requeridos.';
                recuperacionModalMessage.className = 'text-red-600';
                return;
            }
            recuperacionModalMessage.textContent = 'Enviando código de verificación...';
            recuperacionModalMessage.className = 'text-blue-600';

            try {
                const endpoint = `${BACKEND_URL}/api/email/enviar_codigo`;
                const body = { email, cedula };
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                if (response.ok) {
                    recuperacionModalMessage.textContent = result.mensaje || 'Código enviado. Revise su correo.';
                    recuperacionModalMessage.className = 'text-green-600';
                    recuperacionCodigoLabel.classList.remove('hidden');
                    recuperacionCodigo.classList.remove('hidden');
                    btnValidarCodigo.classList.remove('hidden');
                    btnEnviarRecuperacion.classList.add('hidden'); // Oculta el botón

                    // Mostrar conteo de 30 segundos
                    let timeLeft = 30;
                    recuperacionModalMessage.textContent += ` Espera ${timeLeft} segundos para reenviar.`;
                    recuperacionCountdownInterval = setInterval(() => {
                        timeLeft--;
                        recuperacionModalMessage.textContent = `Código enviado. Revise su correo. Espera ${timeLeft} segundos para reenviar.`;
                        if (timeLeft <= 0) {
                            clearInterval(recuperacionCountdownInterval);
                            btnEnviarRecuperacion.classList.remove('hidden'); // Muestra el botón
                            recuperacionModalMessage.textContent = 'Puedes reenviar el código si no lo recibiste.';
                        }
                    }, 1000);
                } else {
                    recuperacionModalMessage.textContent = result.error || 'No se pudo enviar el código.';
                    recuperacionModalMessage.className = 'text-red-600';
                }
            } catch (error) {
                recuperacionModalMessage.textContent = 'Error de conexión al servidor.';
                recuperacionModalMessage.className = 'text-red-600';
            }
        });

        // Validar código y generar clave temporal
        btnValidarCodigo.addEventListener('click', async () => {
            const cedula = recuperacionCedula.value.trim();
            const email = recuperacionEmail.value.trim();
            const usuario = recuperacionUsuario.value.trim();
            const codigo = recuperacionCodigo.value.trim();
            recuperacionModalMessage.textContent = '';

            if (!cedula || !email || !codigo || (tipoRecuperacion === 'clave' && !usuario)) {
                recuperacionModalMessage.textContent = 'Complete todos los campos requeridos.';
                recuperacionModalMessage.className = 'text-red-600';
                return;
            }
            recuperacionModalMessage.textContent = 'Validando código...';
            recuperacionModalMessage.className = 'text-blue-600';

            try {
                const endpoint = `${BACKEND_URL}/api/auth/verificar_codigo_cambiar_clave`;
                const body = tipoRecuperacion === 'usuario'
                    ? { cedula, correo: email, codigo }
                    : { cedula, usuario, correo: email, codigo };
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                if (response.ok) {
                    recuperacionModalMessage.textContent = result.mensaje || 'Clave temporal enviada al correo.';
                    recuperacionModalMessage.className = 'text-green-600';
                    recuperacionCodigoLabel.classList.add('hidden');
                    recuperacionCodigo.classList.add('hidden');
                    btnValidarCodigo.classList.add('hidden');
                    setTimeout(() => {
                        recuperacionModal.classList.add('hidden'); // Cierra el modal después de 2 segundos
                    }, 2000);
                } else {
                    recuperacionModalMessage.textContent = result.error || 'Código incorrecto o expirado.';
                    recuperacionModalMessage.className = 'text-red-600';
                }
            } catch (error) {
                recuperacionModalMessage.textContent = 'Error de conexión al servidor.';
                recuperacionModalMessage.className = 'text-red-600';
            }
        });            

        // Sub-tab switching function for Personal Access
        function openPersonalSubTab(evt, subTabName) {
            // Oculta todos los sub-tabs
            document.querySelectorAll('.personal-sub-tab-content').forEach(tab => {
                tab.classList.add('hidden');
                tab.classList.remove('active');
            });

            // Desactiva todos los botones
                document.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));

            // Muestra el sub-tab seleccionado
            const selectedTab = document.getElementById(subTabName);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                selectedTab.classList.add('active');
            }

            // Activa el botón correspondiente
            if (evt) {
                evt.currentTarget.classList.add('active');
            } else {
                document.querySelector(`.sub-tab-button[onclick*='${subTabName}']`).classList.add('active');
            }
        }

        // Main tab switching function
        function openTab(evt, tabName) {
            // 1. Hide all main sections and HR-specific elements
            const tabContents = document.querySelectorAll('.section');
            tabContents.forEach(tabContent => tabContent.classList.add('hidden'));
            
            // Explicitly ensure hrMainLayout is hidden by default before any logic
            hrMainLayout.classList.add('hidden');
            hrMainLayout.classList.remove('flex'); // Ensure flex is removed if it was there

            // Reset main tab button styles
            const tabButtons = document.querySelectorAll('#global-header-nav button');
            tabButtons.forEach(tabButton => {
                tabButton.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                tabButton.classList.add('bg-blue-100', 'text-gray-800', 'hover:bg-blue-200');
            });

            // Hide HR floating elements and stop polling
            menuToggle.style.display = 'none';
            notificationBell.style.display = 'none';
            hrMenuPanel.classList.remove('open');
            menuToggle.classList.remove('menu-pushed');
            hrMainLayout.classList.remove('menu-pushed');
            assistanceNotificationPopup.classList.remove('open');
            clearInterval(assistancePollingInterval);
            clearInterval(filledFormsPollingInterval);

            // Hide personal access elements by default, will be shown if personal tab is selected
            btnSolicitarAsistencia.classList.add('hidden');
            assistanceMessage.classList.add('hidden');

            // 2. Show the selected section based on tabName
            if (tabName === 'personalAccess') {
                sectionPersonal.classList.remove('hidden');
                btnSolicitarAsistencia.classList.remove('hidden');
                assistanceMessage.classList.remove('hidden');
                btnPersonal.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                btnPersonal.classList.remove('bg-blue-100', 'text-gray-800', 'hover:bg-blue-200');
                openPersonalSubTab(null, 'curriculumForm'); // Activate default sub-tab for personal access
                
            } else if (tabName === 'adminTools') {
                btnRrhh.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                btnRrhh.classList.remove('bg-blue-100', 'text-gray-800', 'hover:bg-blue-200');

                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));

                if (loggedInUser && (loggedInUser.privilegio === 'Admin' || loggedInUser.privilegio === 'Recursos Humanos')) {
                    sectionLogin.classList.add('hidden'); // Hide login form if already logged in
                    hrMainLayout.classList.remove('hidden'); // Show HR main layout
                    hrMainLayout.classList.add('flex'); // Add flex display
                    menuToggle.style.display = 'block';
                    notificationBell.style.display = 'block';
                    startAssistanceRequestPolling(); // Start polling
                    startFilledFormsPolling(); // Start polling
                    showHrSection('section-rrhh-content'); // Default to employee list for HR
                } else {
                    sectionLogin.classList.remove('hidden'); // Show login form if not logged in
                    hrMainLayout.classList.add('hidden'); // Ensure hrMainLayout is hidden
                    hrMainLayout.classList.remove('flex'); // Ensure flex is removed
                }
            }
        }

        // Hacerla global para el onclick del HTML
        window.openPersonalSubTab = openPersonalSubTab;

        let isEmailVerified = false;
        let countdownInterval;
        let assistancePollingInterval;
        let filledFormsPollingInterval;
        let lastKnownFilledFormsCount = 0;

        // Store fetched inmueble types to retrieve their 'type' property
        let inmuebleTypes = [];


        // Chart instances to manage updates
        let totalChartInstance;
        let educationGerenciaChartInstance;
        let educationCargoChartInstance;
        let coursesGerenciaChartInstance;
        let genderDistributionChartInstance;
        let maritalStatusChartInstance;
        let nationalityDistributionChartInstance;
        let experienceOverviewChartInstance;
        let languagesByLevelChartInstance;
        let skillsOverviewChartInstance;

        // --- Utility Functions ---

        // --- Referencias personales dinámicas ---
        const referencesFieldsContainer = document.getElementById('references-fields-container');
        const addReferenceButton = document.getElementById('add-reference');
        const referencesWarning = document.getElementById('references-warning');
        let referenceCounter = 0;

        function addReferenceField(data = {}) {
            referenceCounter++;
            const div = document.createElement('div');
            div.className = 'reference-entry border border-blue-200 p-4 rounded-lg bg-blue-100 relative space-y-4';
            div.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nombre y Apellido</label>
                    <input type="text" name="reference_name_${referenceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${data.nombre || ''}">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Dirección</label>
                        <input type="text" name="reference_address_${referenceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${data.direccion || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                        <input type="text" name="reference_phone_${referenceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${data.telefono || ''}">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ocupación</label>
                        <input type="text" name="reference_job_${referenceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${data.ocupacion || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Parentesco / Relación</label>
                        <input type="text" name="reference_relationship_${referenceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${data.parentesco || ''}">
                    </div>
                </div>
                <button type="button" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700 text-lg font-bold remove-reference">×</button>
            `;
            referencesFieldsContainer.appendChild(div);

            div.querySelector('.remove-reference').addEventListener('click', () => {
                div.remove();
                checkReferencesMinimum();
            });
            checkReferencesMinimum();
        }

        function checkReferencesMinimum() {
            const count = referencesFieldsContainer.querySelectorAll('.reference-entry').length;
            referencesWarning.classList.toggle('hidden', count >= 2);
            addReferenceButton.disabled = count >= 3; // Máximo 3 referencias

            // Siempre deja al menos un campo visible
            if (count === 0) addReferenceField();
        }

        addReferenceButton.addEventListener('click', () => addReferenceField());

        // Inicializa con un campo al cargar la página
        referencesFieldsContainer.innerHTML = '';
        referenceCounter = 0;
        addReferenceField();

        // --- Mostrar "Cargo propuesto" solo si hay sesión ---
        const proposedPositionContainer = document.getElementById('proposed-position-container');
        function showProposedPositionIfLoggedIn() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (loggedInUser) {
                proposedPositionContainer.classList.remove('hidden');
            } else {
                proposedPositionContainer.classList.add('hidden');
            }
        }
        
        showProposedPositionIfLoggedIn();
        window.addEventListener('storage', showProposedPositionIfLoggedIn); // Por si cambia sesión

        const nombreLocalidadContainer = document.getElementById('nombre-localidad-container');
        const nombreLocalidadInput = document.getElementById('nombre-localidad');

        localidadSelect.addEventListener('change', function() {
            // Si selecciona una localidad válida, muestra el campo para el nombre
            if (this.value) {
                nombreLocalidadContainer.style.display = 'block';
            } else {
                nombreLocalidadContainer.style.display = 'none';
                nombreLocalidadInput.value = '';
            }
        });

        importFileInput.addEventListener('change', () => {
        importSelectedTableBtn.disabled = !importFileInput.files.length || !importTableSelect.value;
        });

        importTableSelect.addEventListener('change', () => {
            importSelectedTableBtn.disabled = !importFileInput.files.length || !importTableSelect.value;
        });

        importSelectedTableBtn.addEventListener('click', async () => {
            importMessage.textContent = '';
            if (!importFileInput.files.length || !importTableSelect.value) {
                importMessage.textContent = 'Seleccione una tabla y un archivo CSV.';
                importMessage.className = 'text-blue-800';
                return;
            }
            const file = importFileInput.files[0];
            const table = importTableSelect.value;
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                importMessage.textContent = 'Debe iniciar sesión como RRHH o Admin.';
                importMessage.className = 'text-blue-800';
                return;
            }
            importMessage.textContent = 'Importando datos...';
            importMessage.className = 'text-blue-600';

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csvText = e.target.result;
                    const response = await fetch(`${BACKEND_URL}/api/data/import/${table}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain; charset=utf-8',
                            'X-User-Cedula': loggedInUser.cedula,
                            'X-User-Privilegio': loggedInUser.privilegio
                        },
                        body: csvText
                    });
                    const result = await response.json();
                    if (response.ok) {
                        importMessage.textContent = result.message || 'Datos importados con éxito.';
                        importMessage.className = 'text-blue-600';
                    } else {
                        importMessage.textContent = result.error || 'Error al importar datos.';
                        importMessage.className = 'text-blue-800';
                    }
                } catch (error) {
                    importMessage.textContent = 'Error de conexión al servidor.';
                    importMessage.className = 'text-blue-800';
                }
            };
            reader.readAsText(file, 'utf-8-sig');
        });

        exportTableSelect.addEventListener('change', () => {
        exportSelectedTableBtn.disabled = !exportTableSelect.value;
        });

        // Referencias a los selects
            const precargaGerenciaGeneralSelect = document.getElementById('precarga-gerencia-general');
            const precargaGerenciaEspecificaSelect = document.getElementById('precarga-gerencia-especifica');
            const precargaCargoSelect = document.getElementById('precarga-cargo');

            // Función para poblar un select desde el backend
            async function fetchAndPopulateSelect(url, selectElement, valueField = 'id', textField = 'nombre') {
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    selectElement.innerHTML = '<option value="">Seleccione...</option>';
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[valueField];
                        option.textContent = item[textField];
                        selectElement.appendChild(option);
                    });
                } catch (error) {
                    selectElement.innerHTML = '<option value="">Error al cargar</option>';
                }
            }

            // Poblar Gerencia General al cargar
            fetchAndPopulateSelect(`${BACKEND_URL}/api/organizacion/gerencias_generales`, precargaGerenciaGeneralSelect);

            // Poblar Gerencia Específica cuando cambia Gerencia General
            precargaGerenciaGeneralSelect.addEventListener('change', () => {
                const idGerenciaGeneral = precargaGerenciaGeneralSelect.value;
                if (idGerenciaGeneral) {
                    fetchAndPopulateSelect(`${BACKEND_URL}/api/organizacion/gerencias_especificas?id_gerencia_general=${encodeURIComponent(idGerenciaGeneral)}`, precargaGerenciaEspecificaSelect);
                    precargaCargoSelect.innerHTML = '<option value="">Seleccione...</option>';
                } else {
                    precargaGerenciaEspecificaSelect.innerHTML = '<option value="">Seleccione...</option>';
                    precargaCargoSelect.innerHTML = '<option value="">Seleccione...</option>';
                }
            });

            // Poblar Cargos cuando cambia Gerencia Específica
            precargaGerenciaEspecificaSelect.addEventListener('change', () => {
                const idGerenciaEspecifica = precargaGerenciaEspecificaSelect.value;
                if (idGerenciaEspecifica) {
                    fetchAndPopulateSelect(`${BACKEND_URL}/api/organizacion/cargos?id_gerencia_especifica=${encodeURIComponent(idGerenciaEspecifica)}`, precargaCargoSelect);
                } else {
                    precargaCargoSelect.innerHTML = '<option value="">Seleccione...</option>';
                }
            });

        exportSelectedTableBtn.addEventListener('click', async () => {
            exportMessage.textContent = '';
            const table = exportTableSelect.value;
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                exportMessage.textContent = 'Debe iniciar sesión como RRHH o Admin.';
                exportMessage.className = 'text-blue-800';
                return;
            }
            if (!table) {
                exportMessage.textContent = 'Seleccione una tabla para exportar.';
                exportMessage.className = 'text-blue-800';
                return;
            }
            exportMessage.textContent = 'Exportando datos...';
            exportMessage.className = 'text-blue-600';

            try {
                if (table === 'todas') {
                    // Exportar todas las tablas como ZIP
                    const response = await fetch(`${BACKEND_URL}/api/data/export_all`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cedula: loggedInUser.cedula,
                            privilegio: loggedInUser.privilegio
                        })
                    });
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'todas_las_tablas.zip';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        exportMessage.textContent = 'Exportación completada.';
                        exportMessage.className = 'text-blue-600';
                    } else {
                        const result = await response.json();
                        exportMessage.textContent = result.error || 'Error al exportar datos.';
                        exportMessage.className = 'text-blue-800';
                    }
                } else {
                    // Exportar una sola tabla como CSV
                    const response = await fetch(`${BACKEND_URL}/api/data/export/${table}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cedula: loggedInUser.cedula,
                            privilegio: loggedInUser.privilegio
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        // Generar y descargar CSV
                        if (!data || data.length === 0) {
                            exportMessage.textContent = 'No hay datos para exportar.';
                            exportMessage.className = 'text-blue-800';
                            return;
                        }
                        const headers = Object.keys(data[0]);
                        const csvRows = [];
                        csvRows.push(headers.map(h => `"${h}"`).join(';'));
                        for (const row of data) {
                            const values = headers.map(header => {
                                let value = row[header];
                                value = value == null ? '' : String(value);
                                return `"${value.replace(/"/g, '""')}"`;
                            });
                            csvRows.push(values.join(','));
                        }
                        const csvString = csvRows.join('\n');
                        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `export_${table}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                        exportMessage.textContent = 'Exportación completada.';
                        exportMessage.className = 'text-blue-600';
                    } else {
                        exportMessage.textContent = data.error || 'Error al exportar datos.';
                        exportMessage.className = 'text-blue-800';
                    }
                }
            } catch (error) {
                exportMessage.textContent = 'Error de conexión al servidor.';
                exportMessage.className = 'text-blue-800';
            }
        });
        
        exportTableSelect.addEventListener('change', () => {
        exportSelectedTableBtn.disabled = !exportTableSelect.value;
        });

        exportSelectedTableBtn.addEventListener('click', async () => {
            exportMessage.textContent = '';
            const table = exportTableSelect.value;
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!loggedInUser) {
                exportMessage.textContent = 'Debe iniciar sesión como RRHH o Admin.';
                exportMessage.className = 'text-blue-800';
                return;
            }
            if (!table) {
                exportMessage.textContent = 'Seleccione una tabla para exportar.';
                exportMessage.className = 'text-blue-800';
                return;
            }
            exportMessage.textContent = 'Exportando datos...';
            exportMessage.className = 'text-blue-600';

            try {
                if (table === 'todas') {
                    // Exportar todas las tablas como ZIP
                    const response = await fetch(`${BACKEND_URL}/api/data/export_all`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cedula: loggedInUser.cedula,
                            privilegio: loggedInUser.privilegio
                        })
                    });
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'todas_las_tablas.zip';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        exportMessage.textContent = 'Exportación completada.';
                        exportMessage.className = 'text-blue-600';
                    } else {
                        const result = await response.json();
                        exportMessage.textContent = result.error || 'Error al exportar datos.';
                        exportMessage.className = 'text-blue-800';
                    }
                } else {
                    // Exportar una sola tabla como CSV
                    const response = await fetch(`${BACKEND_URL}/api/data/export/${table}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cedula: loggedInUser.cedula,
                            privilegio: loggedInUser.privilegio
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        // Generar y descargar CSV
                        if (!data || data.length === 0) {
                            exportMessage.textContent = 'No hay datos para exportar.';
                            exportMessage.className = 'text-blue-800';
                            return;
                        }
                        const headers = Object.keys(data[0]);
                        const csvRows = [];
                        csvRows.push(headers.map(h => `"${h}"`).join(';'));
                        for (const row of data) {
                            const values = headers.map(header => {
                                let value = row[header];
                                value = value == null ? '' : String(value);
                                return `"${value.replace(/"/g, '""')}"`;
                            });
                            csvRows.push(values.join(','));
                        }
                        const csvString = csvRows.join('\n');
                        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `export_${table}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                        exportMessage.textContent = 'Exportación completada.';
                        exportMessage.className = 'text-blue-600';
                    } else {
                        exportMessage.textContent = data.error || 'Error al exportar datos.';
                        exportMessage.className = 'text-blue-800';
                    }
                }
            } catch (error) {
                exportMessage.textContent = 'Error de conexión al servidor.';
                exportMessage.className = 'text-blue-800';
            }
        });
            
        function closeMenu() {
            hrMenuPanel.classList.remove('open');
            hrMainLayout.classList.remove('menu-pushed');
            menuToggle.classList.remove('menu-pushed');
        }

        menuToggle.addEventListener('click', () => {
            hrMenuPanel.classList.toggle('open');
            updateContentMargin();
        });

        closeMenuBtn.addEventListener('click', () => {
            hrMenuPanel.classList.remove('open');
            menuToggle.classList.remove('menu-pushed');
            hrMainLayout.classList.remove('menu-pushed');
        });

        function updateContentMargin() {
            if (hrMenuPanel.classList.contains('open')) {
                hrContentArea.classList.add('hr-content-area-with-menu');
                menuToggle.classList.add('menu-pushed'); // <-- Asegúrate de esto
                hrMainLayout.classList.add('menu-pushed');
            } else {
                hrContentArea.classList.remove('hr-content-area-with-menu');
                menuToggle.classList.remove('menu-pushed'); // <-- Y esto
                hrMainLayout.classList.remove('menu-pushed');
            }
        }

        // HR Section switching function (called from HR menu)
        function showHrSection(sectionId) {
            const allHrContentSections = document.querySelectorAll('.hr-section');
            allHrContentSections.forEach(section => section.classList.add('hidden')); // Hide all HR sections

            // Select all menu buttons that show HR sections. Include the new button.
            const menuHrButtons = [
                menuShowEmployeeListButton,
                menuShowDashboardButton,
                menuShowSurveyStatusButton,
                menuShowDatabaseButton,
                menuShowPrecargaButton // Include the new button
            ];
            menuHrButtons.forEach(btn => {
                // Remove all specific background colors and add a default inactive color
                btn.classList.remove('bg-blue-600', 'bg-blue-700', 'bg-blue-800', 'bg-blue-900', 'bg-purple-600');
                btn.classList.add('bg-blue-500'); // Default blue style for inactive in menu
            });


            document.getElementById(sectionId).classList.remove('hidden'); // Show the selected HR section

            if (sectionId === 'section-rrhh-content') {
                menuShowEmployeeListButton.classList.remove('bg-blue-500');
                menuShowEmployeeListButton.classList.add('bg-blue-600');
                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (loggedInUser) {
                    loadEmployeeDataForHR(loggedInUser.cedula, loggedInUser.privilegio);
                }
            } else if (sectionId === 'section-dashboard-content') {
                menuShowDashboardButton.classList.remove('bg-blue-500');
                menuShowDashboardButton.classList.add('bg-blue-700');
                loadDashboardData();
                updateLastKnownFilledFormsCount();
            } else if (sectionId === 'section-survey-status-content') {
                menuShowSurveyStatusButton.classList.remove('bg-blue-500');
                menuShowSurveyStatusButton.classList.add('bg-blue-800');
                loadSurveyStatusData();
                updateLastKnownFilledFormsCount();
                // Reinicia el contador del menú
                menuCountSpan.textContent = '0';
                menuCountSpan.classList.add('hidden');
            } else if (sectionId === 'section-database-content') {
                menuShowDatabaseButton.classList.remove('bg-blue-500');
                menuShowDatabaseButton.classList.add('bg-blue-900');
                // Reset dropdowns and messages when navigating to DB section
                exportTableSelect.value = '';
                exportSelectedTableBtn.disabled = true;
                exportMessage.textContent = '';
                importTableSelect.value = '';
                importFileInput.value = '';
                importSelectedTableBtn.disabled = true;
                importMessage.textContent = '';
            } else if (sectionId === 'section-precarga-content') { // Handle the new precarga section
                menuShowPrecargaButton.classList.remove('bg-blue-500');
                menuShowPrecargaButton.classList.add('bg-purple-600'); // Use a distinct color
                precargaForm.reset();
                precargaMessage.textContent = ''; // Clear message on load
            }
        }


        // Utility function to populate a select element with options
        function populateSelect(selectElement, data, placeholder = 'Seleccione...') {
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id; // Use 'id' for value
                option.textContent = item.nombre; // Use 'nombre' for display text
                selectElement.appendChild(option);
            });
        }

        // --- Location Data Fetching Functions ---
        // New: Fetch Localidades
        async function fetchStates() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/ubicaciones/estados`);
                const data = await response.json();
                if (response.ok) {
                    populateSelect(estadoSelect, data);
                } else {
                    console.error('Error fetching estados:', data.error);
                    populateSelect(estadoSelect, [], 'Error cargando estados');
                }
            } catch (error) {
                console.error('Error de conexión al obtener estados:', error);
                populateSelect(estadoSelect, [], 'Error de conexión');
            }
        }

        async function fetchLocalidades() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/ubicaciones/localidades`);
                const data = await response.json();
                if (response.ok) {
                    populateSelect(localidadSelect, data);
                } else {
                    console.error('Error fetching localidades:', data.error);
                    populateSelect(localidadSelect, [], 'Error cargando localidades');
                }
            } catch (error) {
                console.error('Error de conexión al obtener localidades:', error);
                populateSelect(localidadSelect, [], 'Error de conexión');
            }
        }

        // New: Fetch Inmuebles
        async function fetchInmuebles() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/ubicaciones/inmuebles`);
                const data = await response.json();
                if (response.ok) {
                    inmuebleTypes = data; // Store data to get 'type' later
                    populateSelect(inmuebleSelect, data);
                } else {
                    console.error('Error fetching inmuebles:', data.error);
                    populateSelect(inmuebleSelect, [], 'Error cargando inmuebles');
                }
            } catch (error) {
                console.error('Error de conexión al obtener inmuebles:', error);
                populateSelect(inmuebleSelect, [], 'Error de conexión');
            }
        }

        // Modified: fetchCities now only depends on estadoId
        async function fetchCities(estadoId) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/ubicaciones/ciudades?id_estado=${estadoId}`);
                const data = await response.json();
                if (response.ok) {
                    populateSelect(ciudadSelect, data);
                } else {
                    console.error('Error fetching cities:', data.error);
                    populateSelect(ciudadSelect, [], 'Error cargando ciudades');
                }
            } catch (error) {
                console.error('Error de conexión al obtener ciudades:', error);
                populateSelect(ciudadSelect, [], 'Error de conexión');
            }
        }

        // Modified: fetchMunicipalities now depends on ciudadId
        async function fetchMunicipalities(ciudadId) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/ubicaciones/municipios?id_ciudad=${ciudadId}`);
                const data = await response.json();
                if (response.ok) {
                    populateSelect(municipioSelect, data);
                } else {
                    console.error('Error fetching municipalities:', data.error);
                    populateSelect(municipioSelect, [], 'Error cargando municipios');
                }
            } catch (error) {
                console.error('Error de conexión al obtener municipios:', error);
                populateSelect(municipioSelect, [], 'Error de conexión');
            }
        }

        // Modified: fetchParishes now depends on municipioId
        async function fetchParishes(municipioId) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/ubicaciones/parroquias?id_municipio=${municipioId}`);
                const data = await response.json();
                if (response.ok) {
                    populateSelect(parroquiaSelect, data);
                } else {
                    console.error('Error fetching parishes:', data.error);
                    populateSelect(parroquiaSelect, [], 'Error cargando parroquias');
                }
            } catch (error) {
                console.error('Error de conexión al obtener parroquias:', error);
                populateSelect(parroquiaSelect, [], 'Error de conexión');
            }
        }

                // Lógica para la ventana flotante de notificaciones

        if (notificationBell && assistanceNotificationPopup) {
            notificationBell.addEventListener('click', () => {
                assistanceNotificationPopup.classList.toggle('open');
            });
        }

        if (closeAssistancePopupBtn && assistanceNotificationPopup) {
            closeAssistancePopupBtn.addEventListener('click', () => {
                assistanceNotificationPopup.classList.remove('open');
            });
        }

        // Opcional: Cerrar la ventana flotante si se hace clic fuera de ella
        document.addEventListener('click', (event) => {
            if (assistanceNotificationPopup.classList.contains('open') &&
                !assistanceNotificationPopup.contains(event.target) &&
                !notificationBell.contains(event.target)) {
                assistanceNotificationPopup.classList.remove('open');
            }
        });

        // Function to update the dynamic inmueble fields
        function updateInmuebleSpecificFields() {
            const selectedInmuebleId = inmuebleSelect.value;
            const selectedInmueble = inmuebleTypes.find(item => String(item.id) === selectedInmuebleId);
            inmuebleSpecificFields.innerHTML = ''; // Clear previous fields

            if (selectedInmueble) {
                if (selectedInmueble.tipo === 'casa') {
                    inmuebleSpecificFields.innerHTML = `
                        <div class="col-span-full">
                            <label for="numero_casa" class="block text-sm font-medium text-gray-700">Número de Casa</label>
                            <input type="text" id="numero_casa" name="numero_casa" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: A-12">
                        </div>
                    `;
                } else if (selectedInmueble.tipo === 'edificio' || selectedInmueble.tipo === 'apartamento') { // Assuming 'apartamento' also uses these fields
                    inmuebleSpecificFields.innerHTML = `
                        <div>
                            <label for="edificio_bloque_torre" class="block text-sm font-medium text-gray-700">Edificio/Bloque/Torre</label>
                            <input type="text" id="edificio_bloque_torre" name="edificio_bloque_torre" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: Torre A">
                        </div>
                        <div>
                            <label for="piso" class="block text-sm font-medium text-gray-700">Piso</label>
                            <input type="text" id="piso" name="piso" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 5">
                        </div>
                        <div>
                            <label for="puerta" class="block text-sm font-medium text-gray-700">Puerta/Apartamento</label>
                            <input type="text" id="puerta" name="puerta" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 5A">
                        </div>
                    `;
                }
            }
            // Add event listeners to new inputs for address preview
            inmuebleSpecificFields.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateAddressPreview);
            });
            updateAddressPreview(); // Update preview after changing fields
        }

        // Function to update the live address preview
        function updateAddressPreview() {
            const localidadText = localidadSelect.options[localidadSelect.selectedIndex]?.textContent || '';
            const nombreLocalidadText = nombreLocalidadInput.value.trim() || '';
            const inmuebleText = inmuebleSelect.options[inmuebleSelect.selectedIndex]?.textContent || '';
            
            let inmuebleDetail = '';
            const numeroCasaInput = document.getElementById('numero_casa');
            const edificioBloqueTorreInput = document.getElementById('edificio_bloque_torre');
            const pisoInput = document.getElementById('piso');
            const puertaInput = document.getElementById('puerta');

            if (numeroCasaInput && numeroCasaInput.value) {
                inmuebleDetail = ` (${numeroCasaInput.value})`;
            } else if (edificioBloqueTorreInput && edificioBloqueTorreInput.value) {
                let parts = [];
                if (edificioBloqueTorreInput.value) parts.push(edificioBloqueTorreInput.value);
                if (pisoInput && pisoInput.value) parts.push(`Piso ${pisoInput.value}`);
                if (puertaInput && puertaInput.value) parts.push(`Puerta ${puertaInput.value}`);
                inmuebleDetail = ` ${parts.join(', ')}`;
            }

            const parroquiaText = parroquiaSelect.options[parroquiaSelect.selectedIndex]?.textContent || '';
            const municipioText = municipioSelect.options[municipioSelect.selectedIndex]?.textContent || '';
            const ciudadText = ciudadSelect.options[ciudadSelect.selectedIndex]?.textContent || '';
            const estadoText = estadoSelect.options[estadoSelect.selectedIndex]?.textContent || '';
            const zonaPostalText = zonaPostalInput.value.trim() || '';

            const addressParts = [];
            if (localidadText || nombreLocalidadText) {
                addressParts.push(
                    nombreLocalidadText
                        ? `${localidadText} ${nombreLocalidadText}`.trim()
                        : localidadText
                );
            }
            if (inmuebleText) addressParts.push(`${inmuebleText}${inmuebleDetail}`);
            if (parroquiaText) addressParts.push(parroquiaText);
            if (municipioText) addressParts.push(municipioText);
            if (ciudadText) addressParts.push(ciudadText);
            if (estadoText) addressParts.push(estadoText);
            if (zonaPostalText) addressParts.push(`CP ${zonaPostalText}`);

            addressPreviewSpan.textContent = addressParts.join(', ');
        }

        let pregradoCounter = 0;
        function addPregradoField(data = {}) {
            pregradoCounter++;
            const div = document.createElement('div');
            div.className = 'education-entry grid grid-cols-1 md:grid-cols-3 gap-4 border border-blue-200 p-4 rounded-lg bg-blue-100 relative';
            div.innerHTML = `
                <div>
                    <label for="pregrado-career-${pregradoCounter}" class="block text-sm font-medium text-gray-700">Nombre de la Carrera</label>
                    <input type="text" id="pregrado-career-${pregradoCounter}" name="pregrado_career_${pregradoCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.nombre_carrera || ''}">
                </div>
                <div>
                    <label for="pregrado-grade-${pregradoCounter}" class="block text-sm font-medium text-gray-700">Grado de Educación</label>
                    <select id="pregrado-grade-${pregradoCounter}" name="pregrado_grade_${pregradoCounter}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">Seleccione...</option>
                        ${gradoPregradoOptions.map(opt => `<option value="${opt.toLowerCase()}" ${data.nivel_educativo === opt.toLowerCase() ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label for="pregrado-grad-date-${pregradoCounter}" class="block text-sm font-medium text-gray-700">Fecha de Graduación</label>
                    <input type="date" id="pregrado-grad-date-${pregradoCounter}" name="pregrado_grad_date_${pregradoCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.fecha_graduacion ? new Date(data.fecha_graduacion).toISOString().split('T')[0] : ''}">
                </div>
                <button type="button" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700 text-lg font-bold remove-pregrado">×</button>
            `;
            pregradoFieldsContainer.appendChild(div);

            div.querySelector('.remove-pregrado').addEventListener('click', () => {
                div.remove();
            });
        }

        let posgradoCounter = 0;
        function addPosgradoField(data = {}) {
            posgradoCounter++;
            const div = document.createElement('div');
            div.className = 'education-entry grid grid-cols-1 md:grid-cols-3 gap-4 border border-blue-200 p-4 rounded-lg bg-blue-100 relative';
            div.innerHTML = `
                <div>
                    <label for="posgrado-career-${posgradoCounter}" class="block text-sm font-medium text-gray-700">Carrera/Especialización</label>
                    <input type="text" id="posgrado-career-${posgradoCounter}" name="posgrado_career_${posgradoCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.nombre_carrera || ''}">
                </div>
                <div>
                    <label for="posgrado-grade-${posgradoCounter}" class="block text-sm font-medium text-gray-700">Grado de Educación</label>
                    <select id="posgrado-grade-${posgradoCounter}" name="posgrado_grade_${posgradoCounter}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">Seleccione...</option>
                        ${gradoPosgradoOptions.map(opt => `<option value="${opt.toLowerCase()}" ${data.nivel_educativo === opt.toLowerCase() ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label for="posgrado-grad-date-${posgradoCounter}" class="block text-sm font-medium text-gray-700">Fecha de Graduación</label>
                    <input type="date" id="posgrado-grad-date-${posgradoCounter}" name="posgrado_grad_date_${posgradoCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.fecha_graduacion ? new Date(data.fecha_graduacion).toISOString().split('T')[0] : ''}">
                </div>
                <button type="button" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700 text-lg font-bold remove-posgrado">×</button>
            `;
            posgradoFieldsContainer.appendChild(div);

            div.querySelector('.remove-posgrado').addEventListener('click', () => {
                div.remove();
            });
        }


        let experienceCounter = 0;
        function addExperienceField(data = {}) {
            experienceCounter++;
            const div = document.createElement('div');
            div.className = 'experience-entry grid grid-cols-1 md:grid-cols-2 gap-4 border border-blue-200 p-4 rounded-lg bg-blue-100 relative';
            div.innerHTML = `
                <div>
                    <label for="exp-empresa-${experienceCounter}" class="block text-sm font-medium text-gray-700">Nombre de la Empresa/Institución</label>
                    <input type="text" id="exp-empresa-${experienceCounter}" name="exp_empresa_${experienceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.nombre_empresa || ''}">
                </div>
                <div>
                    <label for="exp-fecha-ingreso-${experienceCounter}" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="exp-fecha-ingreso-${experienceCounter}" name="exp_fecha_ingreso_${experienceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.fecha_ingreso ? new Date(data.fecha_ingreso).toISOString().split('T')[0] : ''}">
                </div>
                <div>
                    <label for="exp-fecha-egreso-${experienceCounter}" class="block text-sm font-medium text-gray-700">Fecha de Egreso (Dejar vacío si es actual)</label>
                    <input type="date" id="exp-fecha-egreso-${experienceCounter}" name="exp_fecha_egreso_${experienceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.fecha_egreso ? new Date(data.fecha_egreso).toISOString().split('T')[0] : ''}">
                </div>
                <div>
                    <label for="exp-dependencia-${experienceCounter}" class="block text-sm font-medium text-gray-700">Dependencia Organizativa</label>
                    <input type="text" id="exp-dependencia-${experienceCounter}" name="exp_dependencia_${experienceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.dependencia_organizativa || ''}">
                </div>
                <div>
                    <label for="exp-cargo-${experienceCounter}" class="block text-sm font-medium text-gray-700">Cargo</label>
                    <input type="text" id="exp-cargo-${experienceCounter}" name="exp_cargo_${experienceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.cargo || ''}">
                </div>
                <div>
                    <label for="exp-telefono-${experienceCounter}" class="block text-sm font-medium text-gray-700">Teléfono de la Empresa</label>
                    <input type="text" id="exp-telefono-${experienceCounter}" name="exp_telefono_${experienceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.telefono || ''}">
                </div>
                <div class="col-span-full">
                    <label for="exp-ultimo-sueldo-${experienceCounter}" class="block text-sm font-medium text-gray-700">Último Sueldo (mensual)</label>
                    <input type="number" step="0.01" id="exp-ultimo-sueldo-${experienceCounter}" name="exp_ultimo_sueldo_${experienceCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.ultimo_sueldo || ''}">
                </div>
                <button type="button" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700 text-lg font-bold remove-experience">×</button>
            `;
            experienceFieldsContainer.appendChild(div);

            div.querySelector('.remove-experience').addEventListener('click', () => {
                div.remove();
            });
        }

        let courseCounter = 0;
        function addCourseField(data = {}) {
            courseCounter++;
            const div = document.createElement('div');
            div.className = 'course-entry grid grid-cols-1 md:grid-cols-2 gap-4 border border-blue-200 p-4 rounded-lg bg-blue-100 relative';
            div.innerHTML = `
                <div>
                    <label for="course-name-${courseCounter}" class="block text-sm font-medium text-gray-700">Nombre del Curso</label>
                    <input type="text" id="course-name-${courseCounter}" name="course_name_${courseCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.nombre_curso || ''}">
                </div>
                <div>
                    <label for="course-institution-${courseCounter}" class="block text-sm font-medium text-gray-700">Institución</label>
                    <input type="text" id="course-institution-${courseCounter}" name="course_institution_${courseCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.institucion || ''}">
                </div>
                <div>
                    <label for="course-fecha-inicio-${courseCounter}" class="block text-sm font-medium text-gray-700">Fecha de Inicio</label>
                    <input type="date" id="course-fecha-inicio-${courseCounter}" name="course_fecha_inicio_${courseCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.fecha_inicio ? new Date(data.fecha_inicio).toISOString().split('T')[0] : ''}">
                </div>
                <div>
                    <label for="course-fecha-fin-${courseCounter}" class="block text-sm font-medium text-gray-700">Fecha de Fin</label>
                    <input type="date" id="course-fecha-fin-${courseCounter}" name="course_fecha_fin_${courseCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.fecha_fin ? new Date(data.fecha_fin).toISOString().split('T')[0] : ''}">
                </div>
                <div class="col-span-full">
                    <label for="course-duration-${courseCounter}" class="block text-sm font-medium text-gray-700">Horas de Duración</label>
                    <input type="number" id="course-duration-${courseCounter}" name="course_duration_${courseCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 40" value="${data.duracion_horas || ''}">
                </div>
                <button type="button" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700 text-lg font-bold remove-course">×</button>
            `;
            coursesFieldsContainer.appendChild(div);

            div.querySelector('.remove-course').addEventListener('click', () => {
                div.remove();
            });
        }

        // Define la lista de idiomas que se usarán en el dropdown
        const languageOptions = [
            "Español", "Inglés", "Francés", "Portugués", "Italiano", "Alemán", "Ruso", "Japonés",
            "Chino mandarín", "Coreano", "Árabe", "Hindi", "Turco", "Holandés", "Sueco", "Noruego",
            "Finlandés", "Danés", "Polaco", "Checo", "Húngaro", "Griego", "Hebreo", "Tailandés",
            "Vietnamita", "Malayo", "Indonesio", "Tagalo", "Ucraniano", "Rumano", "Serbio", "Búlgaro",
            "Eslovaco", "Croata", "Lituano", "Estonio", "Letón", "Islandés", "Afrikáans", "Swahili",
            "Zulu", "Bengalí", "Urdu", "Tamil", "Gujarati", "Punjabi", "Kannada", "Telugu",
            "Persa (farsi)", "Pashto", "Kazajo", "Amhárico"
        ];

        // Contador para asegurar IDs y nombres únicos para cada campo de idioma
        let languageCounter = 0;

        /**
         * Añade un nuevo campo de idioma (dropdown) y su nivel (input de texto)
         * al contenedor de idiomas.
         * @param {string} language El idioma a preseleccionar (opcional).
         * @param {string} level El nivel de idioma a prellenar (opcional).
         */
        function addLanguageField(langOrStr = '', levelStr = '') {
            // Permite recibir un objeto {idioma, nivel} o dos strings
            let idioma = '';
            let nivel = '';
            if (typeof langOrStr === 'object' && langOrStr !== null) {
                idioma = langOrStr.idioma || '';
                nivel = langOrStr.nivel || '';
            } else {
                idioma = langOrStr || '';
                nivel = levelStr || '';
            }

            const container = document.getElementById('languages-fields-container');
            if (!container) {
                console.error("Error: El contenedor 'languages-fields-container' no fue encontrado en el HTML.");
                return;
            }

            const newLanguageDiv = document.createElement('div');
            newLanguageDiv.className = 'flex items-center space-x-2 mb-2 language-item';

            // --- Select de idioma ---
            const languageSelect = document.createElement('select');
            languageSelect.id = `language-name-${languageCounter}`;
            languageSelect.name = `idiomas[${languageCounter}][idioma]`;
            languageSelect.className = 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Seleccione un idioma';
            defaultOption.disabled = true;
            defaultOption.selected = !idioma;
            languageSelect.appendChild(defaultOption);

            languageOptions.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.textContent = lang;
                if (lang === idioma) {
                    option.selected = true;
                    defaultOption.selected = false;
                }
                languageSelect.appendChild(option);
            });

            // --- Select de nivel ---
            const levelSelect = document.createElement('select');
            levelSelect.id = `language-level-${languageCounter}`;
            levelSelect.name = `idiomas[${languageCounter}][nivel]`;
            levelSelect.className = 'mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm';

            const defaultLevelOption = document.createElement('option');
            defaultLevelOption.value = '';
            defaultLevelOption.textContent = 'Seleccione Nivel';
            defaultLevelOption.selected = !nivel;
            levelSelect.appendChild(defaultLevelOption);

            const levels = ["A1", "A2", "B1", "B2", "C1", "C2"];
            levels.forEach(lvl => {
                const option = document.createElement('option');
                option.value = lvl;
                option.textContent = lvl;
                if (lvl === nivel) {
                    option.selected = true;
                    defaultLevelOption.selected = false;
                }
                levelSelect.appendChild(option);
            });

            // --- Botón eliminar ---
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'remove-language-btn text-red-600 hover:text-red-800';
            removeButton.textContent = 'X';
            removeButton.addEventListener('click', function() {
                newLanguageDiv.remove();
            });

            newLanguageDiv.appendChild(languageSelect);
            newLanguageDiv.appendChild(levelSelect);
            newLanguageDiv.appendChild(removeButton);

            container.appendChild(newLanguageDiv);

            languageCounter++;
        }

        let skillCounter = 0;
        function addSkillField(data = {}) {
            skillCounter++;
            const div = document.createElement('div');
            div.className = 'skill-entry flex items-center gap-4 border border-blue-200 p-4 rounded-lg bg-blue-100 relative';
            div.innerHTML = `
                <div class="flex-grow">
                    <label for="skill-name-${skillCounter}" class="block text-sm font-medium text-gray-700">Habilidad/Destreza</label>
                    <input type="text" id="skill-name-${skillCounter}" name="skill_name_${skillCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.habilidad || ''}">
                </div>
                <button type="button" class="text-blue-500 hover:text-blue-700 text-lg font-bold remove-skill">×</button>
            `;
            skillsFieldsContainer.appendChild(div);

            div.querySelector('.remove-skill').addEventListener('click', () => {
                div.remove();
            });
        }

        let emergencyContactCounter = 0;
        function addEmergencyContactField(data = {}) {
            emergencyContactCounter++;
            const div = document.createElement('div');
            div.className = 'emergency-contact-entry grid grid-cols-1 md:grid-cols-3 gap-4 border border-gray-200 p-3 rounded-lg bg-gray-50 relative';
            div.innerHTML = `
                <div>
                    <label for="emergency-name-${emergencyContactCounter}" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                    <input type="text" id="emergency-name-${emergencyContactCounter}" name="emergency_name_${emergencyContactCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.nombre || ''}">
                </div>
                <div>
                    <label for="emergency-phone-${emergencyContactCounter}" class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="text" id="emergency-phone-${emergencyContactCounter}" name="emergency_phone_${emergencyContactCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.telefono || ''}">
                </div>
                <div>
                    <label for="emergency-relationship-${emergencyContactCounter}" class="block text-sm font-medium text-gray-700">Parentesco</label>
                    <input type="text" id="emergency-relationship-${emergencyContactCounter}" name="emergency_relationship_${emergencyContactCounter}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${data.parentesco || ''}">
                </div>
                <button type="button" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-lg font-bold remove-emergency-contact">×</button>
            `;
            emergencyContactsContainer.appendChild(div);

            div.querySelector('.remove-emergency-contact').addEventListener('click', () => {
                div.remove();
            });
            
        }

        // Add initial dynamic fields
        addPregradoButton.addEventListener('click', () => addPregradoField());
        addPosgradoButton.addEventListener('click', () => addPosgradoField());
        addExperienceButton.addEventListener('click', () => addExperienceField());
        addCourseButton.addEventListener('click', () => addCourseField());
        addLanguageButton.addEventListener('click', () => addLanguageField());
        addSkillButton.addEventListener('click', () => addSkillField());
        addEmergencyContactButton.addEventListener('click', () => addEmergencyContactField());


        // Initialize with one set of fields for each section if empty
        if (pregradoFieldsContainer.children.length === 0) addPregradoField();
        if (posgradoFieldsContainer.children.length === 0) addPosgradoField();
        if (experienceFieldsContainer.children.length === 0) addExperienceField();
        if (coursesFieldsContainer.children.length === 0) addCourseField();
        if (languagesFieldsContainer.children.length === 0) addLanguageField();
        if (skillsFieldsContainer.children.length === 0) addSkillField();
        if (emergencyContactsContainer.children.length === 0) addEmergencyContactField();


        // Populate static dropdowns
        populateSelect(estadoCivilSelect, estadoCivilOptions.map(opt => ({ id: opt.toLowerCase(), nombre: opt })));
        populateSelect(sexoSelect, sexoOptions.map(opt => ({ id: opt.toLowerCase(), nombre: opt })));
        populateSelect(manoDominanteSelect, manoDominanteOptions.map(opt => ({ id: opt.toLowerCase(), nombre: opt })));
        populateSelect(condicionHabitacionSelect, condicionHabitacionOptions.map(opt => ({ id: opt.toLowerCase(), nombre: opt })));

        // Calculate Age based on Date of Birth
        fechaNacimientoInput.addEventListener('change', () => {
            const dob = new Date(fechaNacimientoInput.value);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            edadInput.value = isNaN(age) ? '' : age;
        });

        // Dynamic children age fields based on number of children
        numHijosInput.addEventListener('input', () => {
            const numHijos = parseInt(numHijosInput.value, 10);
            childrenAgesContainer.innerHTML = ''; // Clear existing fields
            for (let i = 0; i < numHijos; i++) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label for="child-age-${i}" class="block text-sm font-medium text-gray-700">Edad Hijo ${i + 1}</label>
                    <input type="number" id="child-age-${i}" name="child_age_${i}" min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                `;
                childrenAgesContainer.appendChild(div);
            }
        });


        // --- Event Listeners ---
        btnPersonal.addEventListener('click', (event) => openTab(event, 'personalAccess'));
        btnRrhh.addEventListener('click', (event) => openTab(event, 'adminTools'));

        // Menu item click handlers (these will also close the HR menu panel)
        
        menuShowEmployeeListButton.addEventListener('click', () => {
            showHrSection('section-rrhh-content');
            closeMenu();
        });
        menuShowDashboardButton.addEventListener('click', () => {
            showHrSection('section-dashboard-content');
            closeMenu();
        });
        menuShowSurveyStatusButton.addEventListener('click', () => {
            showHrSection('section-survey-status-content');
            closeMenu();
        });
        menuShowDatabaseButton.addEventListener('click', () => {
            showHrSection('section-database-content');
            closeMenu();
        });
        // NEW: Event listener for the new "Pre-carga de Personal" button
        menuShowPrecargaButton.addEventListener('click', () => {
            showHrSection('section-precarga-content');
            closeMenu();
        });

        menuLogoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('loggedInUser');
            rrhhStatusMessage.textContent = '';
            employeeTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Cargando datos...</td></tr>';
            openTab(null, 'personalAccess'); // Go back to personal access (resets state)
            curriculumFormContent.reset();
            resetFormState();
        });

        downloadEmployeeReportButton.addEventListener('click', () => {
            downloadEmployeeReport();
        });

        downloadSurveyReportButton.addEventListener('click', () => {
            downloadSurveyReport();
        });

        // Initialize display to personal section with curriculum form active
        // This is called AFTER all elements are defined, ensuring they exist.
        // The onAuthStateChanged listener will also call openTab on load/auth state change.
        openTab(null, 'personalAccess'); // Use null for event on initial load

        // Populate initial location dropdowns
        fetchStates();
        fetchLocalidades();
        fetchInmuebles();

        // Handle Estado change (updates Ciudad)
        estadoSelect.addEventListener('change', async () => {
            const selectedEstadoId = estadoSelect.value;
            ciudadSelect.disabled = true;
            municipioSelect.disabled = true;
            parroquiaSelect.disabled = true;
            populateSelect(ciudadSelect, [], 'Cargando ciudades...');
            populateSelect(municipioSelect, []);
            populateSelect(parroquiaSelect, []);

            if (selectedEstadoId) {
                await fetchCities(selectedEstadoId);
                ciudadSelect.disabled = false;
            }
            updateAddressPreview();
        });

        // Handle Ciudad change (updates Municipio)
        ciudadSelect.addEventListener('change', async () => {
            const selectedCiudadId = ciudadSelect.value;
            municipioSelect.disabled = true;
            parroquiaSelect.disabled = true;
            populateSelect(municipioSelect, [], 'Cargando municipios...');
            populateSelect(parroquiaSelect, []);

            if (selectedCiudadId) {
                await fetchMunicipalities(selectedCiudadId);
                municipioSelect.disabled = false;
            }
            updateAddressPreview();
        });

        // Handle Municipio change (updates Parroquia)
        municipioSelect.addEventListener('change', async () => {
            const selectedMunicipioId = municipioSelect.value;
            parroquiaSelect.disabled = true;
            populateSelect(parroquiaSelect, [], 'Cargando parroquias...');

            if (selectedMunicipioId) {
                await fetchParishes(selectedMunicipioId);
                parroquiaSelect.disabled = false;
            }
            updateAddressPreview();
        });

        // Handle Parroquia change
        parroquiaSelect.addEventListener('change', updateAddressPreview);
        localidadSelect.addEventListener('change', updateAddressPreview);
        nombreLocalidadInput.addEventListener('input', updateAddressPreview);
        inmuebleSelect.addEventListener('change', updateInmuebleSpecificFields); // Calls updateAddressPreview internally
        zonaPostalInput.addEventListener('input', updateAddressPreview);


        // Toggle visibility of current study fields
        function toggleEstudioActualFields() {
            const isStudying = estaEstudiandoCheckbox.checked;
            estudioActualFieldsDiv.classList.toggle('hidden', !isStudying); // Toggle visibility of the container
            carreraActualInput.disabled = !isStudying;
            anoActualSelect.disabled = !isStudying;
            turnoEstudioSelect.disabled = !isStudying;

            if (!isStudying) {
                carreraActualInput.value = '';
                anoActualSelect.value = '';
                turnoEstudioSelect.value = '';
            }
        }
        estaEstudiandoCheckbox.addEventListener('change', toggleEstudioActualFields);
        toggleEstudioActualFields();


        // Email Verification Logic (Interacts with Backend)
        btnSendCode.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const cedula = cedulaInput.value.trim().toUpperCase();

            if (!email || !cedula) {
                emailStatus.textContent = 'Por favor, ingrese un correo electrónico y cédula.';
                emailStatus.className = 'text-sm mt-1 text-blue-800';
                return;
            }
            if (!/\S+@\S+\.\S+/.test(email)) {
                emailStatus.textContent = 'Formato de correo electrónico inválido.';
                emailStatus.className = 'text-sm mt-1 text-blue-800';
                return;
            }

            emailStatus.textContent = 'Enviando código...';
            emailStatus.className = 'text-sm mt-1 text-blue-600';
            btnSendCode.disabled = true;
            emailInput.disabled = true;

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/email/enviar_codigo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, cedula: cedula })
                });
                const result = await response.json();

                if (response.ok) {
                    emailStatus.textContent = result.mensaje || 'Código de verificación enviado. Revise su bandeja de entrada.';
                    emailStatus.className = 'text-sm mt-1 text-blue-600';
                    emailVerificationArea.classList.remove('hidden');
                    verificationCodeInput.disabled = false;
                    btnVerifyCode.disabled = false;


                    let timeLeft = 60;
                    countdownTimerSpan.textContent = timeLeft;
                    resendCountdownSpan.classList.remove('hidden');

                    countdownInterval = setInterval(() => {
                        timeLeft--;
                        countdownTimerSpan.textContent = timeLeft;
                        if (timeLeft <= 0) {
                            clearInterval(countdownInterval);
                            btnSendCode.disabled = false;
                            resendCountdownSpan.classList.add('hidden');
                            emailStatus.textContent = 'Puedes reenviar el código si no lo recibiste.';
                            emailStatus.className = 'text-sm mt-1 text-blue-600';
                        }
                    }, 1000);

                } else {
                    emailStatus.textContent = result.error || 'Error al enviar el código. Intente de nuevo.';
                    emailStatus.className = 'text-sm mt-1 text-blue-800';
                    btnSendCode.disabled = false;
                    emailInput.disabled = false;
                    emailVerificationArea.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error al enviar código:", error);
                emailStatus.textContent = 'Error de conexión al servidor al enviar código.';
                emailStatus.className = 'text-sm mt-1 text-blue-800';
                btnSendCode.disabled = false;
                emailVerificationArea.classList.add('hidden');
            }
        });

        btnVerifyCode.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const cedula = cedulaInput.value.trim().toUpperCase();
            const enteredCode = verificationCodeInput.value.trim();

            if (!enteredCode) {
                emailStatus.textContent = 'Por favor, ingrese el código de verificación.';
                emailStatus.className = 'text-sm mt-1 text-blue-800';
                return;
            }

            emailStatus.textContent = 'Verificando código...';
            emailStatus.className = 'text-sm mt-1 text-blue-600';
            btnVerifyCode.disabled = true;
            verificationCodeInput.disabled = true;

            try {
                const response = await fetch(`${BACKEND_URL}/api/email/verificar_codigo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, cedula: cedula, code: enteredCode })
                });
                const result = await response.json();

                if (response.ok) {
                    emailStatus.textContent = result.mensaje || 'Correo electrónico verificado con éxito.';
                    emailStatus.className = 'text-sm mt-1 text-blue-600';
                    isEmailVerified = true;
                    clearInterval(countdownInterval);
                    resendCountdownSpan.classList.add('hidden');
                    btnSendCode.disabled = true;
                    emailInput.disabled = true;
                    emailVerificationArea.classList.add('hidden');
                } else {
                    emailStatus.textContent = result.error || 'Código incorrecto o expirado.';
                    emailStatus.className = 'text-sm mt-1 text-blue-800';
                    isEmailVerified = false;
                    btnVerifyCode.disabled = false;
                    verificationCodeInput.disabled = false;
                }
            } catch (error) {
                console.error("Error al verificar código:", error);
                emailStatus.textContent = 'Error de conexión al servidor al verificar código.';
                emailStatus.className = 'text-sm mt-1 text-blue-800';
                btnVerifyCode.disabled = false;
                verificationCodeInput.disabled = false;
            }
        });

        // Cédula Consultation Logic (Interacts with Backend)
        btnConsultCedula.addEventListener('click', async () => {
            const cedula = cedulaInput.value.trim().toUpperCase();
            cedulaStatus.textContent = '';
            cedulaStatus.className = '';

            if (!cedula) {
                cedulaStatus.textContent = 'Por favor, ingrese una cédula para consultar.';
                cedulaStatus.className = 'text-blue-800';
                return;
            }   

                cedulaStatus.textContent = 'Consultando cédula...';
                cedulaStatus.className = 'text-blue-600';

            if (!isEmailVerified) {
                cedulaStatus.textContent = 'Por favor, verifique su correo electrónico antes de consultar datos.';
                cedulaStatus.className = 'text-blue-800';
                return;
            } else {
                
                try {
                    let foundInPrecarga = false;
                    // 1. Try to fetch from the "Precarga" table first
                    try {
                        const precargaResponse = await fetch(`${BACKEND_URL}/api/empleados/consultar_precarga_cedula?cedula=${cedula}`);
                        const precargaResult = await precargaResponse.json();

                        if (precargaResponse.ok) {
                            nombresInput.value = precargaResult.nombres || '';
                            apellidosInput.value = precargaResult.apellidos || '';
                            // Disable these fields as they are pre-loaded
                            nombresInput.disabled = true;
                            apellidosInput.disabled = true;
                            cedulaStatus.textContent = 'Datos pre-cargados encontrados. Complete el resto del formulario.';
                            cedulaStatus.className = 'text-blue-600';
                            foundInPrecarga = true;
                        }
                    } catch (precargaError) {
                        console.warn("Error fetching from precarga (may not exist yet):", precargaError);
                        // If precarga endpoint fails or data not found, continue to regular employee search
                    }

                    if (!foundInPrecarga) {

                        // 2. If not found in precarga, proceed to original "empleados" table
                        const response = await fetch(`${BACKEND_URL}/api/empleados/consultar_cedula?cedula=${cedula}`);
                        const result = await response.json();

                        if (response.ok) {
                            const employee = result;
                            nombresInput.value = employee.nombres || '';
                            apellidosInput.value = employee.apellidos || '';
                            nacionalidadSelect.value = employee.nacionalidad || '';
                            lugarNacimientoInput.value = employee.lugar_nacimiento || '';
                            fechaNacimientoInput.value = employee.fecha_nacimiento ? new Date(employee.fecha_nacimiento).toISOString().split('T')[0] : '';
                            fechaNacimientoInput.dispatchEvent(new Event('change')); // Trigger age calculation
                            estadoCivilSelect.value = employee.estado_civil || '';
                            sexoSelect.value = employee.sexo || '';
                            manoDominanteSelect.value = employee.mano_dominante || '';
                            numHijosInput.value = employee.num_hijos || 0;
                            // Populate children ages
                            childrenAgesContainer.innerHTML = '';
                            if (employee.hijos_edades && employee.hijos_edades.length > 0) {
                                employee.hijos_edades.forEach((age, index) => {
                                    const div = document.createElement('div');
                                    div.innerHTML = `
                                        <label for="child-age-${index}" class="block text-sm font-medium text-gray-700">Edad Hijo ${index + 1}</label>
                                        <input type="number" id="child-age-${index}" name="child_age_${index}" min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${age}">
                                    `;
                                    childrenAgesContainer.appendChild(div);
                                });
                            } else if (employee.num_hijos > 0) { // If num_hijos is present but ages are not
                                numHijosInput.dispatchEvent(new Event('input')); // Trigger dynamic generation of empty fields
                            }
                            emailInput.value = employee.correo_electronico || '';
                            telefonoHabitacionInput.value = employee.telefono_habitacion || '';
                            telefonoPersonalInput.value = employee.telefono_personal || '';
                            // Populate emergency contacts
                            emergencyContactsContainer.innerHTML = '';
                            emergencyContactCounter = 0;
                            if (employee.telefonos_emergencia && employee.telefonos_emergencia.length > 0) {
                                employee.telefonos_emergencia.forEach(contact => addEmergencyContactField(contact));
                            } else {
                                addEmergencyContactField();
                            }
                            
                            profesionInput.value = employee.profesion || '';
                            impedimentoMedicoFisicoTextarea.value = employee.impedimento_medico_fisico || '';
                            tallaCamisaInput.value = employee.talla_camisa || '';
                            tallaPantalonInput.value = employee.talla_pantalon || '';
                            tallaCalzadoInput.value = employee.talla_calzado || '';
                            condicionHabitacionSelect.value = employee.condicion_habitacion || '';


                            // Set values for the new read-only input fields and hidden inputs
                            gerenciaGeneralDisplay.value = employee.gerencia_general || '';
                            gerenciaGeneralHidden.value = employee.gerencia_general || '';
                            gerenciaEspecificaDisplay.value = employee.gerencia_especifica || '';
                            gerenciaEspecificaHidden.value = employee.gerencia_especifica || '';
                            cargoDisplay.value = employee.cargo || '';
                            cargoHidden.value = employee.cargo || '';

                            estaEstudiandoCheckbox.checked = employee.esta_estudiando_actualmente || false;
                            carreraActualInput.value = employee.carrera_actual || '';
                            anoActualSelect.value = employee.ano_actual || '';
                            turnoEstudioSelect.value = employee.turno_estudio || '';
                            toggleEstudioActualFields();

                            // Populate new address fields
                            localidadSelect.value = employee.localidad_id || '';
                            inmuebleSelect.value = employee.inmueble_id || '';
                            updateInmuebleSpecificFields(); // Call to set up specific fields based on inmueble_id
                            zonaPostalInput.value = employee.zona_postal || '';

                            // Populate existing location dropdowns with new dependency chain
                            if (employee.id_estado) {
                                estadoSelect.value = employee.id_estado;
                                await fetchCities(employee.id_estado); // Load cities for this state
                                if (employee.id_ciudad) {
                                    ciudadSelect.value = employee.id_ciudad;
                                    await fetchMunicipalities(employee.id_ciudad); // Load municipalities for this city
                                    if (employee.id_municipio) {
                                        municipioSelect.value = employee.id_municipio;
                                        await fetchParishes(employee.id_municipio); // Load parishes for this municipality
                                        if (employee.parroquia_id) {
                                            parroquiaSelect.value = employee.parroquia_id;
                                        }
                                    }
                                }
                            }
                        if (employee.localidad !== undefined && employee.localidad !== null) {
                            localidadSelect.value = employee.localidad;
                            // Mostrar el campo nombre_localidad si hay localidad seleccionada
                            nombreLocalidadContainer.style.display = 'block';
                        }
                            else {
                                localidadSelect.value = ''; // Reset if no localidad
                                nombreLocalidadContainer.style.display = 'none'; // Hide the input if no localidad
                            }
                            if (employee.tipo_inmueble !== undefined && employee.tipo_inmueble !== null) {
                                inmuebleSelect.value = employee.tipo_inmueble;
                                // Si usas alguna librería tipo Select2, haz: $('#inmueble').val(employee.tipo_inmueble).trigger('change');
                                updateInmuebleSpecificFields(); // Para mostrar los campos dinámicos del inmueble
                            }
                            if (employee.nombre_localidad) {
                                nombreLocalidadInput.value = employee.nombre_localidad;
                            }
                            if (employee.numero_casa) {
                                document.getElementById('numero_casa').value = employee.numero_casa;
                            }
                            if (employee.edificio_bloque_torre) {
                                document.getElementById('edificio_bloque_torre').value = employee.edificio_bloque_torre;
                            }
                            if (employee.piso) {
                                document.getElementById('piso').value = employee.piso;
                            }
                            if (employee.puerta) {
                                document.getElementById('puerta').value = employee.puerta;
                            }
                            
                            updateAddressPreview();


                            // Clear and re-populate dynamic education fields
                            pregradoFieldsContainer.innerHTML = '';
                            pregradoCounter = 0;
                            posgradoFieldsContainer.innerHTML = '';
                            posgradoCounter = 0;

                            if (employee.education && employee.education.length > 0) {
                                employee.education.forEach(edu => {
                                    // Check if degree level matches pregrado or posgrado options
                                    if (edu.tipo_estudio === 'pregrado') { // Check the type of study
                                        addPregradoField(edu);
                                    } else if (edu.tipo_estudio === 'postgrado') { // Check the type of study
                                        addPosgradoField(edu);
                                    }
                                });
                            }
                            // Ensure at least one empty field exists if none were loaded
                            if (pregradoFieldsContainer.children.length === 0) addPregradoField();
                            if (posgradoFieldsContainer.children.length === 0) addPosgradoField();

                            experienceFieldsContainer.innerHTML = '';
                            experienceCounter = 0;
                            if (employee.experience && employee.experience.length > 0) {
                                // Sort experience by end date (or start date if end date is null/empty for current job)
                                employee.experience.sort((a, b) => {
                                    const dateA = a.fecha_egreso ? new Date(a.fecha_egreso) : (a.fecha_ingreso ? new Date(a.fecha_ingreso) : new Date(0));
                                    const dateB = b.fecha_egreso ? new Date(b.fecha_egreso) : (b.fecha_ingreso ? new Date(b.fecha_ingreso) : new Date(0));
                                    // Sort in descending order to show most recent first
                                    return dateB - dateA;
                                });
                                employee.experience.forEach(exp => addExperienceField(exp));
                            } else {
                                addExperienceField();
                            }

                            coursesFieldsContainer.innerHTML = '';
                            courseCounter = 0;
                            if (employee.cursos && employee.cursos.length > 0) {
                                employee.cursos.forEach(course => addCourseField(course));
                            } else {
                                addCourseField();
                            }

                            languagesFieldsContainer.innerHTML = '';
                            languageCounter = 0;
                            if (employee.idiomas && employee.idiomas.length > 0) {
                                languagesFieldsContainer.innerHTML = '';
                                employee.idiomas.forEach(lang => addLanguageField(lang));
                            } else {
                                addLanguageField();
                            }

                            referencesFieldsContainer.innerHTML = '';
                            referenceCounter = 0;
                            if (employee.referencias_personales && employee.referencias_personales.length > 0) {
                                employee.referencias_personales.forEach(ref => addReferenceField(ref));
                            } else {
                                addReferenceField(); // Al menos un campo vacío si no hay referencias
                            }
                        
                            skillsFieldsContainer.innerHTML = '';
                            skillCounter = 0;
                            if (employee.habilidades && employee.habilidades.length > 0) {
                                employee.habilidades.forEach(skill => addSkillField(skill));
                            } else {
                                addSkillField();
                            }

                            // Re-enable nombre and apellido if they were disabled by precarga but now loaded from empleados
                            nombresInput.disabled = false;
                            apellidosInput.disabled = false;

                            cedulaStatus.textContent = 'Datos cargados con éxito.';
                            cedulaStatus.className = 'text-blue-600';

                        } else {
                            cedulaStatus.textContent = result.error || result.mensaje || 'Cédula no encontrada. Por favor, llene el formulario.';
                            cedulaStatus.className = 'text-orange-600';
                            curriculumFormContent.reset();
                            resetFormState();
                        }
                    }



                } catch (error) {
                    console.error("Error al consultar cédula:", error);
                    cedulaStatus.textContent = 'Error de conexión al servidor al consultar cédula.';
                    cedulaStatus.className = 'text-blue-800';
                } finally {
                    btnConsultCedula.disabled = false;
                }
            }    
        });

        // Form Submission Handler (Interacts with Backend)
        console.log
        curriculumFormContent.addEventListener('submit', async (event) => { // Changed to curriculumFormContent
            event.preventDefault();

            formMessage.textContent = '';
            formMessage.className = '';

            if (!isEmailVerified) {
                formMessage.textContent = 'Por favor, verifique su correo electrónico antes de guardar.';
                formMessage.className = 'text-blue-800';
                return;
            }

            const data = {};
            data.cedula = cedulaInput.value.trim().toUpperCase();
            data.nombres = nombresInput.value.trim().toUpperCase();
            data.apellidos = apellidosInput.value.trim().toUpperCase();
            data.nacionalidad = nacionalidadSelect.value.trim();
            data.lugar_nacimiento = lugarNacimientoInput.value.trim();
            data.fecha_nacimiento = fechaNacimientoInput.value.trim();
            data.edad = edadInput.value.trim();
            data.estado_civil = estadoCivilSelect.value.trim();
            data.sexo = sexoSelect.value.trim();
            data.mano_dominante = manoDominanteSelect.value.trim();
            data.num_hijos = parseInt(numHijosInput.value, 10) || 0;
            data.hijos_edades = Array.from(childrenAgesContainer.querySelectorAll('input[type="number"]')).map(input => parseInt(input.value, 10) || 0);
            data.telefono_habitacion = telefonoHabitacionInput.value.trim();
            data.telefono_personal = telefonoPersonalInput.value.trim();
            data.telefonos_emergencia = [];
            emergencyContactsContainer.querySelectorAll('.emergency-contact-entry').forEach(entryDiv => {
                const nombre = entryDiv.querySelector('[name^="emergency_name_"]').value.trim();
                const telefono = entryDiv.querySelector('[name^="emergency_phone_"]').value.trim();
                const parentesco = entryDiv.querySelector('[name^="emergency_relationship_"]').value.trim();
                if (nombre || telefono || parentesco) {
                    data.telefonos_emergencia.push({ nombre, telefono, parentesco });
                }
            });
            data.profesion = profesionInput.value.trim();
            data.impedimento_medico_fisico = impedimentoMedicoFisicoTextarea.value.trim().toUpperCase();
            data.talla_camisa = tallaCamisaInput.value.trim();
            data.talla_pantalon = tallaPantalonInput.value.trim();
            data.talla_calzado = tallaCalzadoInput.value.trim();
            data.condicion_habitacion = condicionHabitacionSelect.value.trim();

            data.email = emailInput.value.trim().toUpperCase();
            data.gerencia_general = gerenciaGeneralHidden.value;
            data.gerencia_especifica = gerenciaEspecificaHidden.value;
            data.cargo = cargoHidden.value;
            
            // New address fields
            data.nombre_localidad = nombreLocalidadInput.value.trim().toUpperCase();
            data.localidad_id = localidadSelect.value;
            data.inmueble_id = inmuebleSelect.value;
            const selectedInmueble = inmuebleTypes.find(item => String(item.id) === inmuebleSelect.value);
            if (selectedInmueble) {
                if (selectedInmueble.tipo === 'casa') {
                    data.numero_casa = document.getElementById('numero_casa')?.value.trim() || null;
                    data.edificio_bloque_torre = null;
                    data.piso = null;
                    data.puerta = null;
                } else if (selectedInmueble.tipo === 'edificio' || selectedInmueble.tipo === 'apartamento') {
                    data.numero_casa = null;
                    data.edificio_bloque_torre = document.getElementById('edificio_bloque_torre')?.value.trim() || null;
                    data.piso = document.getElementById('piso')?.value.trim() || null;
                    data.puerta = document.getElementById('puerta')?.value.trim() || null;
                }
            } else {
                 data.numero_casa = null;
                 data.edificio_bloque_torre = null;
                 data.piso = null;
                 data.puerta = null;
            }
            data.zona_postal = zonaPostalInput.value.trim();

            const referencesEntries = [];
            referencesFieldsContainer.querySelectorAll('.reference-entry').forEach(entryDiv => {
                const nombre = entryDiv.querySelector('[name^="reference_name_"]').value.trim();
                const telefono = entryDiv.querySelector('[name^="reference_phone_"]').value.trim();
                const parentesco = entryDiv.querySelector('[name^="reference_relationship_"]').value.trim();
                const direccion = entryDiv.querySelector('[name^="reference_address_"]').value.trim();
                const ocupacion = entryDiv.querySelector('[name^="reference_job_"]').value.trim();
                if (nombre || telefono || parentesco || direccion || ocupacion) {
                    referencesEntries.push({ nombre, telefono, parentesco, direccion, ocupacion });
                }
            });
            if (referencesEntries.length < 2) {
                referencesWarning.classList.remove('hidden');
                event.preventDefault();
                return;
            }
            data.referencias_personales = referencesEntries;

            // Cargo propuesto solo si visible
            if (!proposedPositionContainer.classList.contains('hidden')) {
                data.cargo_propuesto = document.getElementById('proposed-position').value.trim();
            }

            data.id_estado = estadoSelect.value;
            data.id_ciudad = ciudadSelect.value;
            data.id_municipio = municipioSelect.value;
            data.parroquia_id = parroquiaSelect.value;

            data.esta_estudiando_actualmente = estaEstudiandoCheckbox.checked;
            data.carrera_actual = estaEstudiandoCheckbox.checked ? carreraActualInput.value.trim() : null;
            data.ano_actual = estaEstudiandoCheckbox.checked ? anoActualSelect.value.trim() : null;
            data.turno_estudio = estaEstudiandoCheckbox.checked ? turnoEstudioSelect.value.trim() : null;


            const educationEntries = [];
            pregradoFieldsContainer.querySelectorAll('.education-entry').forEach(entryDiv => {
                const carrera = entryDiv.querySelector('[name^="pregrado_career_"]').value.trim();
                const grado = entryDiv.querySelector('[name^="pregrado_grade_"]').value.trim();
                const fechaGraduacion = entryDiv.querySelector('[name^="pregrado_grad_date_"]').value.trim();
                if (carrera || grado || fechaGraduacion) {
                    educationEntries.push({
                        nombre_carrera: carrera,
                        nivel_educativo: grado,
                        fecha_graduacion: fechaGraduacion,
                        tipo_estudio: 'pregrado'
                    });
                }
            });
            posgradoFieldsContainer.querySelectorAll('.education-entry').forEach(entryDiv => {
                const carrera = entryDiv.querySelector('[name^="posgrado_career_"]').value.trim();
                const grado = entryDiv.querySelector('[name^="posgrado_grade_"]').value.trim();
                const fechaGraduacion = entryDiv.querySelector('[name^="posgrado_grad_date_"]').value.trim();
                if (carrera || grado || fechaGraduacion) {
                    educationEntries.push({
                        nombre_carrera: carrera,
                        nivel_educativo: grado,
                        fecha_graduacion: fechaGraduacion,
                        tipo_estudio: 'postgrado'
                    });
                }
            });
            data.education = educationEntries;


            const experienceEntries = [];
            experienceFieldsContainer.querySelectorAll('.experience-entry').forEach(entryDiv => {
                const empresa = entryDiv.querySelector('[name^="exp_empresa_"]').value.trim();
                const fechaIngreso = entryDiv.querySelector('[name^="exp_fecha_ingreso_"]').value.trim();
                const fechaEgreso = entryDiv.querySelector('[name^="exp_fecha_egreso_"]').value.trim();
                const dependencia = entryDiv.querySelector('[name^="exp_dependencia_"]').value.trim();
                const cargo = entryDiv.querySelector('[name^="exp_cargo_"]').value.trim();
                const telefono = entryDiv.querySelector('[name^="exp_telefono_"]').value.trim();
                const ultimoSueldo = entryDiv.querySelector('[name^="exp_ultimo_sueldo_"]').value.trim();

                if (empresa || fechaIngreso || fechaEgreso || dependencia || cargo || telefono || ultimoSueldo) {
                    experienceEntries.push({
                        nombre_empresa: empresa,
                        fecha_ingreso: fechaIngreso,
                        fecha_egreso: fechaEgreso,
                        dependencia_organizativa: dependencia,
                        cargo: cargo,
                        telefono: telefono,
                        ultimo_sueldo: parseFloat(ultimoSueldo) || 0
                    });
                }
            });
            data.experience = experienceEntries;


            const coursesEntries = [];
            coursesFieldsContainer.querySelectorAll('.course-entry').forEach(entryDiv => {
                const nombreCurso = entryDiv.querySelector('[name^="course_name_"]').value.trim();
                const institucion = entryDiv.querySelector('[name^="course_institution_"]').value.trim();
                const fechaInicio = entryDiv.querySelector('[name^="course_fecha_inicio_"]').value.trim();
                const fechaFin = entryDiv.querySelector('[name^="course_fecha_fin_"]').value.trim();
                const horasDuracion = entryDiv.querySelector('[name^="course_duration_"]').value.trim();
                if (nombreCurso || institucion || fechaInicio || fechaFin || horasDuracion) {
                    coursesEntries.push({
                        nombre_curso: nombreCurso,
                        institucion: institucion,
                        fecha_inicio: fechaInicio,
                        fecha_fin: fechaFin,
                        duracion_horas: parseInt(horasDuracion) || 0
                    });
                }
            });
            data.cursos = coursesEntries;

            const languagesEntries = [];
            languagesFieldsContainer.querySelectorAll('.language-item').forEach(entryDiv => {
                const idioma = entryDiv.querySelector('[name^="idiomas"][name$="[idioma]"]').value.trim();
                const nivel = entryDiv.querySelector('[name^="idiomas"][name$="[nivel]"]').value.trim();
                if (idioma || nivel) {
                    languagesEntries.push({
                        idioma: idioma,
                        nivel: nivel
                    });
                }
            });
            data.languages = languagesEntries;

            const skillsEntries = [];
            skillsFieldsContainer.querySelectorAll('.skill-entry').forEach(entryDiv => {
                const habilidad = entryDiv.querySelector('[name^="skill_name_"]').value.trim();
                if (habilidad) {
                    skillsEntries.push({
                        habilidad: habilidad
                    });
                }
            });
            data.skills = skillsEntries;

                data.direccion = {
                id_estado: estadoSelect.value || null,
                id_municipio: municipioSelect.value || null,
                parroquia_id: parroquiaSelect.value || null,
                id_ciudad: ciudadSelect.value || null,
                localidad: localidadSelect.value || null,
                nombre_localidad: nombreLocalidadInput.value.trim() || null,
                tipo_inmueble: inmuebleSelect.value || null,
                numero_casa: document.getElementById('numero_casa')?.value.trim() || null,
                edificio_bloque_torre: document.getElementById('edificio_bloque_torre')?.value.trim() || null,
                piso: document.getElementById('piso')?.value.trim() || null,
                puerta: document.getElementById('puerta')?.value.trim() || null,
                direccion_detallada: addressPreviewSpan.textContent.trim() || null,
                zona_postal: zonaPostalInput.value.trim() || null,
                condicion_habitacion: condicionHabitacionSelect.value || null
                
            };

            formMessage.textContent = 'Guardando cambios...';
            formMessage.className = 'text-blue-600';

            try {
                const response = await fetch(`${BACKEND_URL}/api/empleados/actualizar_curriculum`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (response.ok) {
                    formMessage.textContent = result.mensaje || 'Currículum actualizado con éxito.';
                    formMessage.className = 'text-blue-600';
                    curriculumFormContent.reset();
                    resetFormState();
                } else {
                    formMessage.textContent = result.error || 'Error al actualizar el currículum. Verifique los datos.';
                    formMessage.className = 'text-blue-800';
                }
            } catch (error) {
                    console.error("Error al enviar formulario:", error);
                    formMessage.textContent = 'Error de conexión al servidor al guardar el currículum.';
                    formMessage.className = 'text-blue-800';
            }
        });

        // Function to reset the state of email verification
        function resetEmailVerificationState() {
            emailVerificationArea.classList.add('hidden');
            btnSendCode.disabled = false;
            emailInput.disabled = false;
            verificationCodeInput.value = '';
            verificationCodeInput.disabled = false;
            btnVerifyCode.disabled = false;
            emailStatus.textContent = '';
            resendCountdownSpan.classList.add('hidden');
            clearInterval(countdownInterval);
            isEmailVerified = false;
        }

        // Function to reset the entire form state after submission or error
        function resetFormState() {
            resetEmailVerificationState();

            // Clear display-only and hidden inputs for organizational info
            gerenciaGeneralDisplay.value = '';
            gerenciaGeneralHidden.value = '';
            gerenciaEspecificaDisplay.value = '';
            gerenciaEspecificaHidden.value = '';
            cargoDisplay.value = '';
            cargoHidden.value = '';

            // Referencias personales
            referencesFieldsContainer.innerHTML = '';
            referenceCounter = 0; // Reinicia el contador
            addReferenceField();   // Solo deja un campo vacío

            // Reset new personal info fields
            nacionalidadSelect.value = '';
            lugarNacimientoInput.value = '';
            fechaNacimientoInput.value = '';
            edadInput.value = '';
            estadoCivilSelect.value = '';
            sexoSelect.value = '';
            manoDominanteSelect.value = '';
            numHijosInput.value = 0;
            childrenAgesContainer.innerHTML = ''; // Clear children age fields
            telefonoHabitacionInput.value = '';
            telefonoPersonalInput.value = '';
            emergencyContactsContainer.innerHTML = '';
            addEmergencyContactField(); // Add one empty emergency contact field
            profesionInput.value = '';
            impedimentoMedicoFisicoTextarea.value = '';
            tallaCamisaInput.value = '';
            tallaPantalonInput.value = '';
            tallaCalzadoInput.value = '';
            condicionHabitacionSelect.value = '';

            // Re-enable nombres and apellidos fields if they were disabled by precarga
            nombresInput.disabled = false;
            apellidosInput.disabled = false;

            estaEstudiandoCheckbox.checked = false;
            carreraActualInput.value = '';
            anoActualSelect.value = '';
            turnoEstudioSelect.value = '';
            toggleEstudioActualFields();

            // Re-initialize dynamic fields with one empty set
            pregradoFieldsContainer.innerHTML = '';
            pregradoCounter = 0;
            addPregradoField();
            posgradoFieldsContainer.innerHTML = '';
            posgradoCounter = 0;
            addPosgradoField();
            
            experienceFieldsContainer.innerHTML = '';
            experienceCounter = 0;
            addExperienceField();
            coursesFieldsContainer.innerHTML = '';
            courseCounter = 0;
            addCourseField();
            languagesFieldsContainer.innerHTML = '';
            languageCounter = 0;
            addLanguageField();
            skillsFieldsContainer.innerHTML = '';
            skillCounter = 0;
            addSkillField();

            // Reset new address fields
            localidadSelect.value = '';
            inmuebleSelect.value = '';
            updateInmuebleSpecificFields(); // Clear dynamic inmueble fields
            zonaPostalInput.value = '';
            addressPreviewSpan.textContent = ''; // Clear address preview

            // Re-fetch states and reset dependent dropdowns
            fetchStates();
            fetchLocalidades();
            fetchInmuebles();
            ciudadSelect.disabled = true;
            municipioSelect.disabled = true;
            parroquiaSelect.disabled = true;
            populateSelect(ciudadSelect, []);
            populateSelect(municipioSelect, []);
            populateSelect(parroquiaSelect, []);
            
            cedulaStatus.textContent = '';
        }


        // Initialize dependent dropdowns as disabled until parent is selected
        ciudadSelect.disabled = true;
        municipioSelect.disabled = true;
        parroquiaSelect.disabled = true;

        // --- Login Form Logic ---
        console.log(loginForm)
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            loginMessage.textContent = '';
            loginMessage.className = '';

            const cedula = loginCedulaInput.value.trim().toUpperCase();
            const clave = loginClaveInput.value.trim();

            const encoder = new TextEncoder();
            const decoder = new TextDecoder('utf-8', { fatal: false });
            const sanitizedCedula = decoder.decode(encoder.encode(cedula));
            const sanitizedClave = decoder.decode(encoder.encode(clave));

            if (!sanitizedCedula || !sanitizedClave) {
                loginMessage.textContent = 'Por favor, ingrese cédula y clave.';
                loginMessage.className = 'text-blue-800';
                return;
            }

            loginMessage.textContent = 'Iniciando sesión...';
            loginMessage.className = 'text-blue-600';

            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cedula: sanitizedCedula, clave: sanitizedClave })
                });
                const result = await response.json();
                console.log('Login Response:', result); // Log the response for debugging

                if (response.ok) {
                    // Fetch the user's personal phone number after successful login
                    const userPhoneResponse = await fetch(`${BACKEND_URL}/api/empleados/consultar_cedula?cedula=${result.cedula}`);
                    const userPhoneData = await userPhoneResponse.json();
                    
                    let userPersonalPhone = '';
                    if (userPhoneResponse.ok && userPhoneData && userPhoneData.telefono_personal) {
                        userPersonalPhone = userPhoneData.telefono_personal;
                    } else {
                        console.warn('Could not fetch HR user personal phone number:', userPhoneData.error || 'Unknown error');
                    }

                    sessionStorage.setItem('loggedInUser', JSON.stringify({
                        cedula: result.cedula,
                        privilegio: result.privilegio,
                        telefono_personal: userPersonalPhone // Store HR user's phone number
                    }));
                    loginMessage.textContent = result.mensaje;
                    loginMessage.className = 'text-blue-600';

                    // Manually trigger openTab for 'adminTools' to refresh UI state
                    openTab(null, 'adminTools'); 

                } else {
                    loginMessage.textContent = result.error || 'Error de autenticación. Verifique su cédula y clave.';
                    loginMessage.className = 'text-blue-800';
                    sessionStorage.removeItem('loggedInUser'); // Ensure session is cleared on failed login
                    // Manually trigger openTab for 'adminTools' to ensure UI is reset to login form
                    openTab(null, 'adminTools');
                }
            } catch (error) {
                console.error("Error en login:", error);
                loginMessage.textContent = `Error de conexión al servidor. Asegúrate de que el backend esté corriendo en ${BACKEND_URL}.`;
                loginMessage.className = 'text-blue-800';
                sessionStorage.removeItem('loggedInUser'); // Ensure session is cleared on connection error
                openTab(null, 'adminTools'); // Ensure UI is reset to login form
            }
        });

        // --- Load Employee Data for HR View ---
        async function loadEmployeeDataForHR(userCedula, userPrivilege) {
            rrhhStatusMessage.textContent = 'Cargando datos de empleados...';
            rrhhStatusMessage.className = 'text-blue-600';
            employeeTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Cargando datos...</td></tr>';

            try {
                const response = await fetch(`${BACKEND_URL}/api/rrhh/empleados`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cedula: userCedula, privilegio: userPrivilege })
                });
                const result = await response.json();

                if (response.ok) {
                    rrhhStatusMessage.textContent = '';
                    employeeTableBody.innerHTML = '';

                    if (result.length > 0) {
                        result.forEach(employee => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${employee.cedula}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.nombres}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.apellidos}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.gerencia_general}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.gerencia_especifica}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.cargo}</td>
                            `;
                            employeeTableBody.appendChild(row);
                        });
                    } else {
                        employeeTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">No hay empleados registrados.</td></tr>';
                    }

                } else {
                    rrhhStatusMessage.textContent = result.error || 'Error al cargar los datos de empleados.';
                    rrhhStatusMessage.className = 'text-blue-800';
                    employeeTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Error al cargar datos.</td></tr>';
                }
            } catch (error) {
                console.error("Error al cargar datos de RRHH:", error);
                rrhhStatusMessage.textContent = 'Error de conexión al servidor al cargar datos de RRHH.';
                rrhhStatusMessage.className = 'text-blue-800';
                employeeTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Error de conexión.</td></tr>';
            }
        }

        // --- Dashboard Data Loading and Charting ---
        async function loadDashboardData() {
            // Destroy existing chart instances to prevent duplicates
            if (totalChartInstance) totalChartInstance.destroy();
            if (educationGerenciaChartInstance) educationGerenciaChartInstance.destroy();
            if (educationCargoChartInstance) educationCargoChartInstance.destroy();
            if (coursesGerenciaChartInstance) coursesGerenciaChartInstance.destroy();
            if (genderDistributionChartInstance) genderDistributionChartInstance.destroy();
            if (maritalStatusChartInstance) maritalStatusChartInstance.destroy();
            if (nationalityDistributionChartInstance) nationalityDistributionChartInstance.destroy();
            if (experienceOverviewChartInstance) experienceOverviewChartInstance.destroy();
            if (languagesByLevelChartInstance) languagesByLevelChartInstance.destroy();
            if (skillsOverviewChartInstance) skillsOverviewChartInstance.destroy();

            // Total Count Chart
            try {
                const response = await fetch(`${BACKEND_URL}/api/dashboard/totals`);
                const data = await response.json();
                filledFormsCountSpan.textContent = data.total_filled_forms;
                totalPersonnelCountSpan.textContent = data.total_personnel;

                const totalCtx = document.getElementById('total-chart').getContext('2d');
                totalChartInstance = new Chart(totalCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Formularios Llenados', 'Total de Personal'],
                        datasets: [{
                            label: 'Cantidad',
                            data: [data.total_filled_forms, data.total_personnel],
                            backgroundColor: ['rgba(37, 99, 235, 0.6)', 'rgba(30, 58, 138, 0.6)'],
                            borderColor: ['rgba(37, 99, 235, 1)', 'rgba(30, 58, 138, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error("Error fetching totals:", error);
                filledFormsCountSpan.textContent = 'N/A';
                totalPersonnelCountSpan.textContent = 'N/A';
            }

            // Education by General Management Chart
            try {
                const response = await fetch(`${BACKEND_URL}/api/dashboard/education_by_gerencia`);
                const data = await response.json();
                const labels = [];
                const datasetMap = new Map();

                data.forEach(item => {
                    const gerencia = item.gerencia_general;
                    const nivel = item.nivel_educativo;
                    const count = item.count;

                    if (!labels.includes(gerencia)) {
                        labels.push(gerencia);
                    }
                    if (!datasetMap.has(nivel)) {
                        datasetMap.set(nivel, new Array(labels.length).fill(0));
                    }
                    const index = labels.indexOf(gerencia);
                    const currentData = datasetMap.get(nivel);
                    currentData[index] = count;
                    datasetMap.set(nivel, currentData);
                });

                const datasets = Array.from(datasetMap.entries()).map(([nivel, counts]) => {
                    const finalCounts = labels.map(label => {
                        const originalIndex = data.findIndex(d => d.gerencia_general === label && d.nivel_educativo === nivel);
                        return originalIndex !== -1 ? data[originalIndex].count : 0;
                    });
                    return {
                        label: nivel,
                        data: finalCounts,
                        backgroundColor: `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},0.6)`,
                        borderColor: `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},1)`,
                        borderWidth: 1
                    };
                });

                const educationGerenciaCtx = document.getElementById('education-gerencia-chart').getContext('2d');
                educationGerenciaChartInstance = new Chart(educationGerenciaCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                            x: { stacked: true, beginAtZero: true },
                            y: { stacked: true }
                        }
                    }
                });

            } catch (error) {
                console.error("Error fetching education by gerencia:", error);
            }

            // Education by Job Title Chart
            try {
                const response = await fetch(`${BACKEND_URL}/api/dashboard/education_by_cargo`);
                const data = await response.json();
                const labels = [];
                const datasetMap = new Map();

                data.forEach(item => {
                    const cargo = item.cargo;
                    const nivel = item.nivel_educativo;
                    const count = item.count;

                    if (!labels.includes(cargo)) {
                        labels.push(cargo);
                    }
                    if (!datasetMap.has(nivel)) {
                        datasetMap.set(nivel, new Array(labels.length).fill(0));
                    }
                    const index = labels.indexOf(cargo);
                    const currentData = datasetMap.get(nivel);
                    currentData[index] = count;
                    datasetMap.set(nivel, currentData);
                });

                const datasets = Array.from(datasetMap.entries()).map(([nivel, counts]) => {
                    const finalCounts = labels.map(label => {
                        const originalIndex = data.findIndex(d => d.cargo === label && d.nivel_educativo === nivel);
                        return originalIndex !== -1 ? data[originalIndex].count : 0;
                    });
                    return {
                        label: nivel,
                        data: finalCounts,
                        backgroundColor: `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},0.6)`,
                        borderColor: `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},1)`,
                        borderWidth: 1
                    };
                });


                const educationCargoCtx = document.getElementById('education-cargo-chart').getContext('2d');
                educationCargoChartInstance = new Chart(educationCargoCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                            x: { stacked: true, beginAtZero: true },
                            y: { stacked: true }
                        }
                    }
                });

            } catch (error) {
                console.error("Error fetching education by cargo:", error);
            }

            // Courses by General Management Chart
            try {
                const response = await fetch(`${BACKEND_URL}/api/dashboard/courses_by_gerencia`);
                const data = await response.json();
                const labels = data.map(item => item.gerencia_general);
                const counts = data.map(item => item.count);
                const backgroundColors = labels.map((_, i) => `rgba(37, ${100 + (i*15) % 100}, ${200 + (i*15) % 50}, 0.6)`);
                const borderColors = labels.map((_, i) => `rgba(37, ${100 + (i*15) % 100}, ${200 + (i*15) % 50}, 1)`);

                const coursesGerenciaCtx = document.getElementById('courses-gerencia-chart').getContext('2d');
                coursesGerenciaChartInstance = new Chart(coursesGerenciaCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Personas con Cursos',
                            data: counts,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error("Error fetching courses by gerencia:", error);
            }

            // Género
            fetch(`${BACKEND_URL}/api/dashboard/gender_distribution`)
                .then(res => res.json())
                .then(data => {
                    const labels = data.map(d => d.sexo);
                    const counts = data.map(d => d.count);
                    const genderCtx = document.getElementById('gender-distribution-chart').getContext('2d');
                    genderDistributionChartInstance = new Chart(genderCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Cantidad',
                                data: counts,
                                backgroundColor: ['#2563eb', '#f59e42', '#a3e635'],
                                borderColor: ['#2563eb', '#f59e42', '#a3e635'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            },
                            plugins: {
                                legend: { display: false },
                                title: { display: true, text: 'Distribución por Género' }
                            }
                        }
                    });
                });

            // Estado Civil
            fetch(`${BACKEND_URL}/api/dashboard/marital_status`)
                .then(res => res.json())
                .then(data => {
                    const labels = data.map(d => d.estado_civil);
                    const counts = data.map(d => d.count);
                    const maritalCtx = document.getElementById('marital-status-chart').getContext('2d');
                    maritalStatusChartInstance = new Chart(maritalCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Cantidad',
                                data: counts,
                                backgroundColor: ['#2563eb', '#f59e42', '#a3e635', '#f43f5e'],
                                borderColor: ['#2563eb', '#f59e42', '#a3e635', '#f43f5e'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            },
                            plugins: {
                                legend: { display: false },
                                title: { display: true, text: 'Distribución por Estado Civil' }
                            }
                        }
                    });
                });

            // Nacionalidad
            fetch(`${BACKEND_URL}/api/dashboard/nationality_distribution`)
                .then(res => res.json())
                .then(data => {
                    const labels = data.map(d => d.nacionalidad);
                    const counts = data.map(d => d.count);
                    const nationalityCtx = document.getElementById('nationality-distribution-chart').getContext('2d');
                    nationalityDistributionChartInstance = new Chart(nationalityCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Cantidad',
                                data: counts,
                                backgroundColor: ['#2563eb', '#f59e42'],
                                borderColor: ['#2563eb', '#f59e42'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            },
                            plugins: {
                                legend: { display: false },
                                title: { display: true, text: 'Distribución por Nacionalidad' }
                            }
                        }
                    });
                });

            // NEW: Experience Overview Chart
            try {
                const response = await fetch(`${BACKEND_URL}/api/dashboard/experience_overview`);
                const data = await response.json();
                const labels = data.map(item => item.has_experience ? 'Con Experiencia' : 'Sin Experiencia');
                const counts = data.map(item => item.count);
                const backgroundColors = ['#1d4ed8', '#9ca3af'];

                const experienceCtx = document.getElementById('experience-overview-chart').getContext('2d');
                experienceOverviewChartInstance = new Chart(experienceCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Número de Empleados',
                            data: counts,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Visión General de Experiencia Laboral' }
                        }
                    }
                });
            } catch (error) {
                console.error("Error fetching experience overview:", error);
            }

            // Languages by Level Chart
            try {
                const response = await fetch(`${BACKEND_URL}/api/dashboard/language_proficiency`);
                const data = await response.json();
                const languages = Array.from(new Set(data.map(item => item.idioma)));
                const levels = Array.from(new Set(data.map(item => item.nivel)));
                levels.sort();

                const datasets = languages.map((lang, langIndex) => ({
                    label: lang,
                    data: levels.map(level => {
                        const found = data.find(item => item.idioma === lang && item.nivel === level);
                        return found ? found.count : 0;
                    }),
                    backgroundColor: `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},0.7)`,
                    borderColor: `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},1)`,
                    borderWidth: 1
                }));

                const languagesCtx = document.getElementById('languages-by-level-chart').getContext('2d');
                languagesByLevelChartInstance = new Chart(languagesCtx, {
                    type: 'bar',
                    data: {
                        labels: levels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true, title: { display: true, text: 'Nivel' } },
                            y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Número de Personas' } }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Idiomas por Nivel' }
                        }
                    }
                });
            } catch (error) {
                console.error("Error fetching language proficiency:", error);
            }

            // NEW: Skills Overview Chart
            try {
            const response = await fetch(`${BACKEND_URL}/api/dashboard/skills_overview`);
            const data = await response.json();
            const labels = data.map(item => item.habilidad);
            const counts = data.map(item => item.count);
            const backgroundColors = labels.map((_, i) => `rgba(16, ${185 + (i*10) % 50}, ${129 - (i*10) % 50}, 0.6)`);

            const skillsCtx = document.getElementById('skills-overview-chart').getContext('2d');
            skillsOverviewChartInstance = new Chart(skillsCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frecuencia de Habilidad',
                        data: counts,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Número de Empleados' } },
                        y: { title: { display: true, text: 'Habilidad' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Habilidades Registradas' }
                    }
                }
            });
        } catch (error) {
            console.error("Error fetching skills overview:", error);
        }
        }

        const btnSurveyCompleted = document.getElementById('btn-survey-completed');
        const btnSurveyPending = document.getElementById('btn-survey-pending');
        const surveyCompletedTab = document.getElementById('survey-completed-tab');
        const surveyPendingTab = document.getElementById('survey-pending-tab');
        const surveyCompletedTableBody = document.getElementById('survey-completed-table-body');
        const surveyPendingTableBody = document.getElementById('survey-pending-table-body');
        const surveyCompletedMessage = document.getElementById('survey-completed-message');
        const surveyPendingMessage = document.getElementById('survey-pending-message');

        btnSurveyCompleted.addEventListener('click', () => {
            btnSurveyCompleted.classList.add('active');
            btnSurveyPending.classList.remove('active');
            surveyCompletedTab.classList.remove('hidden');
            surveyCompletedTab.classList.add('active');
            surveyPendingTab.classList.add('hidden');
            surveyPendingTab.classList.remove('active');
            loadSurveyStatusData('completed');
        });

        btnSurveyPending.addEventListener('click', () => {
            btnSurveyPending.classList.add('active');
            btnSurveyCompleted.classList.remove('active');
            surveyPendingTab.classList.remove('hidden');
            surveyPendingTab.classList.add('active');
            surveyCompletedTab.classList.add('hidden');
            surveyCompletedTab.classList.remove('active');
            loadSurveyStatusData('pending');
        });

        // --- Survey Status Data Loading ---
        async function loadSurveyStatusData(filter = '') {
            surveyCompletedMessage.textContent = '';
            surveyPendingMessage.textContent = '';
            surveyCompletedTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Cargando datos...</td></tr>';
            surveyPendingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Cargando datos...</td></tr>';

            try {
                const response = await fetch(`${BACKEND_URL}/api/dashboard/survey_status`);
                const data = await response.json();

                if (response.ok) {
                    const completed = data.filter(emp => emp.has_filled_form);
                    const pending = data.filter(emp => !emp.has_filled_form);

                    // Realizados
                    surveyCompletedTableBody.innerHTML = '';
                    if (completed.length > 0) {
                        completed.forEach(employee => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${employee.cedula}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.nombres}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.apellidos}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.gerencia_general}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.cargo}</td>
                            `;
                            surveyCompletedTableBody.appendChild(row);
                        });
                        surveyCompletedMessage.textContent = `Total realizados: ${completed.length}`;
                    } else {
                        surveyCompletedTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">No hay empleados que hayan realizado el formulario.</td></tr>';
                        surveyCompletedMessage.textContent = '';
                    }

                    // Pendientes
                    surveyPendingTableBody.innerHTML = '';
                    if (pending.length > 0) {
                        pending.forEach(employee => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${employee.cedula}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.nombres}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.apellidos}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.gerencia_general}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.cargo}</td>
                            `;
                            surveyPendingTableBody.appendChild(row);
                        });
                        surveyPendingMessage.textContent = `Total pendientes: ${pending.length}`;
                    } else {
                        surveyPendingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">No hay empleados pendientes.</td></tr>';
                        surveyPendingMessage.textContent = '';
                    }
                }
            } catch (error) {
                surveyCompletedTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Error al cargar datos.</td></tr>';
                surveyPendingTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Error al cargar datos.</td></tr>';
            }
        }

        btnSearchSurveyStatus.addEventListener('click', () => {
            const cedula = surveyCedulaSearchInput.value.trim().toUpperCase();
            loadSurveyStatusData(cedula);
        });

        btnClearSurveySearch.addEventListener('click', () => {
            surveyCedulaSearchInput.value = '';
            loadSurveyStatusData();
        });


        // --- Report Download Logic (Common function for CSV generation) ---
        async function downloadReport(data, filename, headers = null) {
            if (!data || data.length === 0) {
                alert('No hay datos para generar el reporte.');
                return;
            }

            const actualHeaders = headers || Object.keys(data[0]);
            const csvRows = [];
            csvRows.push(actualHeaders.map(h => `"${h}"`).join(';')); // Headers separated by semicolon

            for (const row of data) {
                const values = actualHeaders.map(header => {
                    let value = row[header];
                    value = value == null ? '' : String(value);
                    // Ensure values are comma-separated for data rows
                    return `"${value.replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(',')); // Data separated by comma
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`Reporte "${filename}" descargado con éxito!`);
        }

        // Specific function for Employee Report download
        async function downloadEmployeeReport() {
            try {
                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (!loggedInUser) {
                    alert('Debes iniciar sesión como RRHH o Admin para descargar el reporte.');
                    return;
                }

                const response = await fetch(`${BACKEND_URL}/api/rrhh/empleados`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cedula: loggedInUser.cedula, privilegio: loggedInUser.privilegio })
                });
                const employees = await response.json();

                if (!response.ok) {
                    alert('Error al obtener los datos para el reporte de empleados: ' + (employees.error || 'Desconocido'));
                    return;
                }
                downloadReport(employees, 'reporte_empleados.csv');

            } catch (error) {
                console.error("Error downloading employee report:", error);
                alert('Ocurrió un error al intentar descargar el reporte de empleados.');
            }
        }

        // Specific function for Survey Report download
        async function downloadSurveyReport() {
            try {
                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (!loggedInUser) {
                    alert('Debes iniciar sesión como RRHH o Admin para descargar el reporte.');
                    return;
                }

                const response = await fetch(`${BACKEND_URL}/api/dashboard/survey_status`);
                const surveyStatusData = await response.json();

                if (!response.ok) {
                    alert('Error al obtener los datos para el reporte de encuestas: ' + (surveyStatusData.error || 'Desconocido'));
                    return;
                }
                downloadReport(surveyStatusData, 'reporte_estado_encuestas.csv');

            } catch (error) {
                console.error("Error downloading survey report:", error);
                alert('Ocurrió un error al intentar descargar el reporte de estado de encuestas.');
            }
        }


        // --- Solicitar Asistencia Logic ---
        btnSolicitarAsistencia.addEventListener('click', async () => {
            assistanceMessage.textContent = '';
            assistanceMessage.className = '';

            const cedula = cedulaInput.value.trim().toUpperCase();
            const nombres = nombresInput.value.trim();
            const apellidos = apellidosInput.value.trim();
            const gerenciaGeneral = gerenciaGeneralHidden.value;

            if (!cedula || !nombres || !apellidos || !gerenciaGeneral) {
                assistanceMessage.textContent = 'Por favor, complete sus datos personales y de gerencia para solicitar asistencia.';
                assistanceMessage.className = 'text-blue-800';
                return;
            }

            assistanceMessage.textContent = 'Enviando solicitud de asistencia...';
            assistanceMessage.className = 'text-blue-600';
            btnSolicitarAsistencia.disabled = true;

            try {
                const response = await fetch(`${BACKEND_URL}/api/solicitar_asistencia`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cedula: cedula,
                        nombres: nombres,
                        apellidos: apellidos,
                        gerencia_general: gerenciaGeneral
                    })
                });
                const result = await response.json();

                if (response.ok) {
                    assistanceMessage.textContent = result.mensaje || 'Solicitud de asistencia enviada con éxito.';
                    assistanceMessage.className = 'text-blue-600';
                } else {
                    assistanceMessage.textContent = result.error || 'Error al enviar la solicitud de asistencia.';
                    assistanceMessage.className = 'text-blue-800';
                }
            } catch (error) {
                console.error("Error al solicitar asistencia:", error);
                assistanceMessage.textContent = 'Error de conexión al servidor al solicitar asistencia.';
                assistanceMessage.className = 'text-blue-800';
            } finally {
                btnSolicitarAsistencia.disabled = false;
            }
        });

        // --- HR Assistance Request Polling ---
        let assistanceRequestCount = 0;

        async function fetchAssistanceRequests() {
            try {
                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                // Only fetch if a privileged user is logged in
                if (!loggedInUser || (loggedInUser.privilegio !== 'Admin' && loggedInUser.privilegio !== 'Recursos Humanos')) {
                    clearInterval(assistancePollingInterval);
                    notificationBell.style.display = 'none';
                    return;
                }

                // Only fetch if the HR section is active
                const currentActiveTabButton = document.querySelector('#global-header-nav button.bg-blue-600');
                if (!currentActiveTabButton || currentActiveTabButton.id !== 'btn-rrhh') {
                    // If not on HR tab, hide bell and stop polling temporarily
                    notificationBell.style.display = 'none';
                    clearInterval(assistancePollingInterval);
                    return;
                }

                notificationBell.style.display = 'block';

                const response = await fetch(`${BACKEND_URL}/api/rrhh/assistance_requests`);
                const requests = await response.json();

                if (response.ok) {
                    const currentRequestsCount = requests.length;

                    if (currentRequestsCount > 0) {
                        notificationBellCountSpan.textContent = currentRequestsCount;
                        notificationBellCountSpan.classList.remove('hidden');
                        notificationBell.classList.add('notification-active'); // Add pulse animation
                    } else {
                        notificationBellCountSpan.textContent = '0';
                        notificationBellCountSpan.classList.add('hidden');
                        notificationBell.classList.remove('notification-active'); // Remove pulse animation
                    }
                    assistanceRequestCount = currentRequestsCount;

                    pendingRequestsList.innerHTML = '';
                    if (requests.length > 0) {
                        for (const req of requests) { // Use for...of with await inside
                            let employeePhoneNumber = '';
                            try {
                                // Fetch the employee's phone number
                                const employeePhoneResponse = await fetch(`${BACKEND_URL}/api/empleados/consultar_cedula?cedula=${req.cedula}`);
                                const employeePhoneData = await employeePhoneResponse.json();
                                if (employeePhoneResponse.ok && employeePhoneData && employeePhoneData.telefono_personal) {
                                    employeePhoneNumber = employeePhoneData.telefono_personal.replace(/\D/g, ''); // Clean phone number for WhatsApp
                                } else {
                                    console.warn(`Could not get phone for ${req.cedula}:`, employeePhoneData.error || 'Unknown error');
                                }
                            } catch (phoneError) {
                                console.error(`Error fetching phone for ${req.cedula}:`, phoneError);
                            }

                            const whatsappLink = employeePhoneNumber ? `https://wa.me/+58${employeePhoneNumber}?text=Hola, estoy contactando sobre la solicitud de asistencia de ${req.nombres} ${req.apellidos} C.I. ${req.cedula}. ¿En que puedo ayudarte?` : '#';

                            const listItem = document.createElement('li');
                            listItem.className = 'assistance-request-item flex flex-col sm:flex-row sm:justify-between sm:items-center bg-blue-100 p-3 rounded-lg mb-2 last:mb-0';
                            listItem.innerHTML = `
                                <div class="flex-grow text-gray-800 text-sm mb-2 sm:mb-0">
                                    <span class="font-semibold">${req.nombres} ${req.apellidos}</span><br>
                                    C.I. ${req.cedula} de ${req.gerencia_general}
                                </div>
                                <div class="flex gap-2 items-center justify-end">
                                    <a href="${whatsappLink}" target="_blank"
                                    class="bg-white border border-green-500 text-green-600 hover:bg-green-50 p-2 rounded-full shadow-md transition duration-200 flex items-center justify-center ${!employeePhoneNumber ? 'opacity-50 cursor-not-allowed' : ''}"
                                    aria-label="Contactar por WhatsApp" ${!employeePhoneNumber ? 'onclick="return false;"' : ''}>
                                        <!-- WhatsApp SVG Icon -->
                                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M16 3C9.373 3 4 8.373 4 15c0 2.385.697 4.607 2.02 6.563L4 29l7.652-2.004A12.94 12.94 0 0016 27c6.627 0 12-5.373 12-12S22.627 3 16 3zm0 22c-1.993 0-3.93-.52-5.627-1.504l-.401-.229-4.543 1.19 1.211-4.429-.261-.406A9.94 9.94 0 016 15c0-5.514 4.486-10 10-10s10 4.486 10 10-4.486 10-10 10zm5.297-7.255c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.198.297-.767.967-.94 1.166-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.477-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.457.13-.606.134-.134.298-.347.447-.521.149-.174.199-.298.298-.497.099-.198.05-.372-.025-.521-.075-.149-.669-1.614-.916-2.211-.242-.581-.487-.502-.669-.511-.173-.007-.372-.009-.571-.009-.198 0-.521.075-.795.372-.273.298-1.043 1.019-1.043 2.484 0 1.465 1.068 2.882 1.217 3.081.149.198 2.104 3.217 5.104 4.381.714.308 1.271.492 1.706.629.717.229 1.37.197 1.884.119.575-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/>
                                        </svg>
                                    </a>
                                    <button data-request-id="${req.id_solicitud}" class="mark-as-resolved-btn px-3 py-1 bg-blue-600 text-white text-xs rounded-md hover:bg-blue-700 transition duration-200">Atendida</button>
                                </div>
                            `;
                            pendingRequestsList.appendChild(listItem);
                        }
                        pendingRequestsList.querySelectorAll('.mark-as-resolved-btn').forEach(button => {
                            button.addEventListener('click', markAssistanceRequestAsResolved);
                        });
                        popupStatusMessage.classList.add('hidden');
                    } else {
                        pendingRequestsList.innerHTML = '<li>No hay solicitudes pendientes.</li>';
                        popupStatusMessage.classList.add('hidden');
                    }
                } else {
                    console.error("Error fetching assistance requests:", requests.error);
                    notificationBell.classList.remove('notification-active');
                    notificationBellCountSpan.textContent = 'Error';
                    notificationBellCountSpan.classList.remove('hidden');
                    pendingRequestsList.innerHTML = '<li>Error al cargar solicitudes.</li>';
                    popupStatusMessage.textContent = requests.error || 'Error al cargar solicitudes.';
                    popupStatusMessage.className = 'text-blue-800 block';
                }
            } catch (error) {
                console.error("Error polling for assistance requests:", error);
                notificationBell.classList.remove('notification-active');
                notificationBellCountSpan.textContent = 'Error';
                notificationBellCountSpan.classList.remove('hidden');
                pendingRequestsList.innerHTML = '<li>Error de conexión.</li>';
                popupStatusMessage.textContent = 'Error de conexión con el servidor.';
                popupStatusMessage.className = 'text-blue-800 block';
            }
        }

        async function markAssistanceRequestAsResolved(event) {
            const requestId = event.target.dataset.requestId;
            if (!requestId) {
                console.error("Request ID is undefined. Cannot mark as resolved.");
                alert('Error: ID de solicitud no encontrado.');
                return;
            }

            event.target.disabled = true;
            event.target.textContent = 'Procesando...';

            try {
                const response = await fetch(`${BACKEND_URL}/api/rrhh/assistance_requests/${requestId}/resolve`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estatus: 'resuelto' })
                });
                const result = await response.json();

                if (response.ok) {
                    console.log(`Solicitud ${requestId} marcada como resuelta.`);
                    fetchAssistanceRequests();
                } else {
                    alert('Error al marcar la solicitud como atendida: ' + (result.error || 'Desconocido'));
                }
            } catch (error) {
                console.error("Error marking assistance request as resolved:", error);
                alert('Error de conexión al servidor al intentar resolver la solicitud.');
            } finally {
                event.target.disabled = false;
                event.target.textContent = 'Atendida';
            }
        }

        function startAssistanceRequestPolling() {
            if (assistancePollingInterval) {
                clearInterval(assistancePollingInterval);
            }
            fetchAssistanceRequests();
            assistancePollingInterval = setInterval(fetchAssistanceRequests, 9502);
        }

        function startFilledFormsPolling() {
            if (filledFormsPollingInterval) {
                clearInterval(filledFormsPollingInterval);
            }
            fetchFilledFormsCount();
            filledFormsPollingInterval = setInterval(fetchFilledFormsCount, 10000);
        }

        // --- Polling for newly filled forms (for menu counter) ---
        async function fetchFilledFormsCount() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/dashboard/survey_status`);
                const data = await response.json();

                // Solo cuenta los realizados
                const realizadosCount = Array.isArray(data)
                    ? data.filter(emp => emp.has_filled_form).length
                    : 0;

                menuCountSpan.textContent = realizadosCount;
                menuCountSpan.classList.toggle('hidden', realizadosCount === 0);
            } catch (error) {
                console.error("Error al obtener el conteo de encuestas realizadas:", error);
                menuCountSpan.textContent = '0';
                menuCountSpan.classList.add('hidden');
            }
        }

        // Mostrar campo "Otro" solo si se selecciona la opción en transporte (ida)
        document.getElementById('transporte-ida-otro-check').addEventListener('change', function() {
            document.getElementById('transporte-ida-otro').classList.toggle('hidden', !this.checked);
        });

        // Mostrar campo "Otro" solo si se selecciona la opción en transporte (regreso)
        document.getElementById('transporte-regreso-otro-check').addEventListener('change', function() {
            document.getElementById('transporte-regreso-otro').classList.toggle('hidden', !this.checked);
        });

        // Mostrar textarea de ruta alterna solo si se selecciona "SI"
        document.querySelectorAll('input[name="ruta_alterna"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('ruta-alterna-descripcion').classList.toggle('hidden', this.value !== 'SI');
            });
        });

        // --- Verificación de correo y bloqueo de consulta de cédula para Declaración de Ruta Habitual ---
            const rutaEmailInput = document.getElementById('ruta-email');
            const btnSendRutaCode = document.getElementById('btn-send-ruta-code');
            const rutaEmailVerificationArea = document.getElementById('ruta-email-verification-area');
            const rutaVerificationCodeInput = document.getElementById('ruta-verification-code');
            const btnVerifyRutaCode = document.getElementById('btn-verify-ruta-code');
            const rutaEmailStatus = document.getElementById('ruta-email-status');
            const rutaResendCountdownSpan = document.getElementById('ruta-resend-countdown');
            const rutaCountdownTimerSpan = document.getElementById('ruta-countdown-timer');
            const rutaCedulaInput = document.getElementById('ruta-cedula');
            const btnConsultRutaCedula = document.getElementById('btn-consult-ruta-cedula');
            const rutaCedulaStatus = document.getElementById('ruta-cedula-status');

            let isRutaEmailVerified = false;
            let rutaCountdownInterval;

            btnSendRutaCode.addEventListener('click', async () => {
                const email = rutaEmailInput.value.trim();
                const cedula = rutaCedulaInput.value.trim().toUpperCase();
                if (!email || !cedula) {
                    rutaEmailStatus.textContent = 'Ingrese correo y cédula antes de enviar el código.';
                    rutaEmailStatus.className = 'text-sm mt-1 text-blue-800';
                    return;
                }
                if (!/\S+@\S+\.\S+/.test(email)) {
                    rutaEmailStatus.textContent = 'Formato de correo electrónico inválido.';
                    rutaEmailStatus.className = 'text-sm mt-1 text-blue-800';
                    return;
                }
                rutaEmailStatus.textContent = 'Enviando código...';
                rutaEmailStatus.className = 'text-sm mt-1 text-blue-600';
                btnSendRutaCode.disabled = true;
                rutaEmailInput.disabled = true;

                if (rutaCountdownInterval) clearInterval(rutaCountdownInterval);

                try {
                    const response = await fetch(`${BACKEND_URL}/api/email/enviar_codigo`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, cedula })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        rutaEmailStatus.textContent = result.mensaje || 'Código enviado. Revise su correo.';
                        rutaEmailStatus.className = 'text-sm mt-1 text-blue-600';
                        rutaEmailVerificationArea.classList.remove('hidden');
                        rutaVerificationCodeInput.disabled = false;
                        btnVerifyRutaCode.disabled = false;
                        let timeLeft = 60;
                        rutaCountdownTimerSpan.textContent = timeLeft;
                        rutaResendCountdownSpan.classList.remove('hidden');
                        rutaCountdownInterval = setInterval(() => {
                            timeLeft--;
                            rutaCountdownTimerSpan.textContent = timeLeft;
                            if (timeLeft <= 0) {
                                clearInterval(rutaCountdownInterval);
                                btnSendRutaCode.disabled = false;
                                rutaResendCountdownSpan.classList.add('hidden');
                                rutaEmailStatus.textContent = 'Puedes reenviar el código si no lo recibiste.';
                                rutaEmailStatus.className = 'text-sm mt-1 text-blue-600';
                            }
                        }, 1000);
                    } else {
                        rutaEmailStatus.textContent = result.error || 'Error al enviar el código.';
                        rutaEmailStatus.className = 'text-sm mt-1 text-blue-800';
                        btnSendRutaCode.disabled = false;
                        rutaEmailInput.disabled = false;
                        rutaEmailVerificationArea.classList.add('hidden');
                    }
                } catch (error) {
                    rutaEmailStatus.textContent = 'Error de conexión al servidor.';
                    rutaEmailStatus.className = 'text-sm mt-1 text-blue-800';
                    btnSendRutaCode.disabled = false;
                    rutaEmailVerificationArea.classList.add('hidden');
                }
            });

            btnVerifyRutaCode.addEventListener('click', async () => {
                const email = rutaEmailInput.value.trim();
                const cedula = rutaCedulaInput.value.trim().toUpperCase();
                const enteredCode = rutaVerificationCodeInput.value.trim();
                if (!enteredCode) {
                    rutaEmailStatus.textContent = 'Ingrese el código de verificación.';
                    rutaEmailStatus.className = 'text-sm mt-1 text-blue-800';
                    return;
                }
                rutaEmailStatus.textContent = 'Verificando código...';
                rutaEmailStatus.className = 'text-sm mt-1 text-blue-600';
                btnVerifyRutaCode.disabled = true;
                rutaVerificationCodeInput.disabled = true;
                try {
                    const response = await fetch(`${BACKEND_URL}/api/email/verificar_codigo`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, cedula, code: enteredCode })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        rutaEmailStatus.textContent = result.mensaje || 'Correo verificado con éxito.';
                        rutaEmailStatus.className = 'text-sm mt-1 text-blue-600';
                        isRutaEmailVerified = true;
                        clearInterval(rutaCountdownInterval);
                        rutaResendCountdownSpan.classList.add('hidden');
                        btnSendRutaCode.disabled = true;
                        rutaEmailInput.disabled = true;
                        rutaEmailVerificationArea.classList.add('hidden');
                    } else {
                        rutaEmailStatus.textContent = result.error || 'Código incorrecto o expirado.';
                        rutaEmailStatus.className = 'text-sm mt-1 text-blue-800';
                        isRutaEmailVerified = false;
                        btnVerifyRutaCode.disabled = false;
                        rutaVerificationCodeInput.disabled = false;
                    }
                } catch (error) {
                    rutaEmailStatus.textContent = 'Error de conexión al servidor.';
                    rutaEmailStatus.className = 'text-sm mt-1 text-blue-800';
                    btnVerifyRutaCode.disabled = false;
                    rutaVerificationCodeInput.disabled = false;
                }
            });

            // Bloquea la consulta de cédula si no está verificado el correo
            btnConsultRutaCedula.addEventListener('click', async function() {
                if (!isRutaEmailVerified) {
                    rutaCedulaStatus.textContent = 'Debe verificar su correo electrónico antes de consultar la cédula.';
                    rutaCedulaStatus.className = 'text-sm mt-1 text-blue-800';
                    return;
                }
                // ...aquí va tu lógica de consulta de cédula...
            });

        // Event listener para el botón "Consultar datos" en la pestaña de Declaración de Ruta Habitual
        document.getElementById('btn-consult-ruta-cedula').addEventListener('click', async function() {
            const cedula = document.getElementById('ruta-cedula').value;

            if (!cedula) {
                alert('Por favor, ingrese una cédula para consultar.');
                return;
            }

            try {
                // Asumiendo que BACKEND_URL ya está definida globalmente
                const response = await fetch(`${BACKEND_URL}/api/declaracion_ruta/${cedula}`);
                const data = await response.json();

                if (response.ok) {
                    // Limpiar mensajes anteriores
                    document.getElementById('ruta-form-message').textContent = '';

                    // Llenar nombres y apellidos (corregido a .nombres y .apellidos)
                    document.getElementById('ruta-nombres').value = data.nombres || '';
                    document.getElementById('ruta-apellidos').value = data.apellidos || '';
                    
                    // Limpiar y ocultar campos de transporte "Otro"
                    document.querySelectorAll('input[name="transporte_ida"]').forEach(cb => cb.checked = false);
                    document.getElementById('transporte-ida-otro').classList.add('hidden');
                    document.getElementById('transporte-ida-otro').value = '';

                    document.querySelectorAll('input[name="transporte_regreso"]').forEach(cb => cb.checked = false);
                    document.getElementById('transporte-regreso-otro').classList.add('hidden');
                    document.getElementById('transporte-regreso-otro').value = '';

                    // Restablecer radios de ruta alterna y ocultar descripción
                    document.querySelector('input[name="ruta_alterna"][value="NO"]').checked = true;
                    document.getElementById('ruta-alterna-descripcion').classList.add('hidden');
                    document.getElementById('ruta-alterna-descripcion').value = '';

                    // Llenar campos de descripción de ruta y hora de salida
                    // AHORA se mapean 'origen' y 'destino' del backend directamente a los textareas
                    document.getElementById('ruta-descripcion-ida').value = data.origen || '';
                    document.getElementById('ruta-descripcion-regreso').value = data.destino || '';
                    document.getElementById('hora-salida-ida').value = data.hora_salida_ida || '';


                    if (data.message && data.message.includes("No se encontró declaración de ruta")) {
                        // Solo se encontró el empleado, pero sin declaración de ruta
                        document.getElementById('ruta-form-message').textContent = data.message;
                        document.getElementById('ruta-form-message').className = 'text-center mt-4 text-lg font-medium text-black-600';
                        // Asegurarse de que los campos de declaración se vacíen si no hay datos de declaración
                        // (aunque ya se vacían arriba si data.origen/destino es vacío)
                    } else if (data.origen) { // Si realmente hay datos de declaración de ruta (data.origen indica que sí)
                        // Marcar el transporte de ida
                        const transporteIdaCheckbox = document.querySelector(`input[name="transporte_ida"][value="${data.transporte_ida}"]`);
                        if (transporteIdaCheckbox) {
                            transporteIdaCheckbox.checked = true;
                            if (data.transporte_ida === 'Otro') {
                                document.getElementById('transporte-ida-otro').classList.remove('hidden');
                                document.getElementById('transporte-ida-otro').value = data.transporte_ida_otro || '';
                            }
                        } else if (data.transporte_ida) {
                            console.warn(`Valor de transporte de ida del backend no coincide con un checkbox: ${data.transporte_ida}`);
                        }

                        // Marcar el transporte de regreso
                        const transporteRegresoCheckbox = document.querySelector(`input[name="transporte_regreso"][value="${data.transporte_regreso}"]`);
                        if (transporteRegresoCheckbox) {
                            transporteRegresoCheckbox.checked = true;
                            if (data.transporte_regreso === 'Otro') {
                                document.getElementById('transporte-regreso-otro').classList.remove('hidden');
                                document.getElementById('transporte-regreso-otro').value = data.transporte_regreso_otro || '';
                            }
                        } else if (data.transporte_regreso) {
                            console.warn(`Valor de transporte de regreso del backend no coincide con un checkbox: ${data.transporte_regreso}`);
                        }

                        // Marcar ruta alterna
                        if (data.ruta_alterna_requerida) {
                            document.querySelector('input[name="ruta_alterna"][value="SI"]').checked = true;
                            document.getElementById('ruta-alterna-descripcion').classList.remove('hidden');
                            document.getElementById('ruta-alterna-descripcion').value = data.ruta_alterna_descripcion || '';
                        } else {
                            document.querySelector('input[name="ruta_alterna"][value="NO"]').checked = true;
                            document.getElementById('ruta-alterna-descripcion').classList.add('hidden');
                            document.getElementById('ruta-alterna-descripcion').value = '';
                        }

                        document.getElementById('ruta-form-message').textContent = 'Datos de declaración de ruta cargados exitosamente.';
                        document.getElementById('ruta-form-message').className = 'text-center mt-4 text-lg font-medium text-black-600';

                    } else {
                        // Este bloque se ejecuta si el empleado no fue encontrado en absoluto, o si la respuesta no tiene 'origen' y tampoco el mensaje específico.
                        // Limpiar todos los campos del formulario si hay un error o no se encuentra el empleado/declaración.
                        document.getElementById('ruta-nombres').value = '';
                        document.getElementById('ruta-apellidos').value = '';
                        document.getElementById('ruta-descripcion-ida').value = '';
                        document.getElementById('ruta-descripcion-regreso').value = '';
                        document.getElementById('hora-salida-ida').value = '';
                        // Los checkboxes y radios ya se limpiaron al inicio del handler.
                        
                        document.getElementById('ruta-form-message').textContent = data.error || data.message || 'Error desconocido al consultar.';
                        document.getElementById('ruta-form-message').className = 'text-center mt-4 text-lg font-medium text-black-600';
                    }

                } else { // Si la respuesta HTTP no fue OK (ej. 404, 500)
                    alert('Error al consultar datos: ' + (data.error || data.message || 'Error desconocido'));
                    // Limpiar todos los campos del formulario
                    document.getElementById('ruta-nombres').value = '';
                    document.getElementById('ruta-apellidos').value = '';
                    document.getElementById('ruta-descripcion-ida').value = '';
                    document.getElementById('ruta-descripcion-regreso').value = '';
                    document.querySelectorAll('input[name="transporte_ida"]').forEach(cb => cb.checked = false);
                    document.getElementById('transporte-ida-otro').classList.add('hidden');
                    document.getElementById('transporte-ida-otro').value = '';
                    document.getElementById('hora-salida-ida').value = '';
                    document.querySelectorAll('input[name="transporte_regreso"]').forEach(cb => cb.checked = false);
                    document.getElementById('transporte-regreso-otro').classList.add('hidden');
                    document.getElementById('transporte-regreso-otro').value = '';
                    document.querySelector('input[name="ruta_alterna"][value="NO"]').checked = true;
                    document.getElementById('ruta-alterna-descripcion').classList.add('hidden');
                    document.getElementById('ruta-alterna-descripcion').value = '';
                    document.getElementById('ruta-form-message').textContent = data.error || data.message || 'Error desconocido.';
                    document.getElementById('ruta-form-message').className = 'text-center mt-4 text-lg font-medium text-black-600';
                }
            } catch (error) {
                console.error('Error en la conexión con el backend:', error);
                alert('Error en la conexión con el servidor. Por favor, intente de nuevo.');
                // Limpiar todos los campos del formulario en caso de error de conexión
                document.getElementById('ruta-nombres').value = '';
                document.getElementById('ruta-apellidos').value = '';
                document.getElementById('ruta-descripcion-ida').value = '';
                document.getElementById('ruta-descripcion-regreso').value = '';
                document.getElementById('hora-salida-ida').value = '';
                document.querySelectorAll('input[name="transporte_ida"]').forEach(cb => cb.checked = false);
                document.getElementById('transporte-ida-otro').classList.add('hidden');
                document.getElementById('transporte-ida-otro').value = '';
                document.querySelectorAll('input[name="transporte_regreso"]').forEach(cb => cb.checked = false);
                document.getElementById('transporte-regreso-otro').classList.add('hidden');
                document.getElementById('transporte-regreso-otro').value = '';
                document.querySelector('input[name="ruta_alterna"][value="NO"]').checked = true;
                document.getElementById('ruta-alterna-descripcion').classList.add('hidden');
                document.getElementById('ruta-alterna-descripcion').value = '';
                document.getElementById('ruta-form-message').textContent = 'Error de conexión con el servidor.';
                document.getElementById('ruta-form-message').className = 'text-center mt-4 text-lg font-medium text-black-600';
            }
        });

        // Event listener para el envío del formulario de Declaración de Ruta Habitual
        document.getElementById('habitualRouteForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevenir el envío tradicional del formulario

            const cedula = document.getElementById('ruta-cedula').value;
            const origen = document.getElementById('ruta-descripcion-ida').value;
            const destino = document.getElementById('ruta-descripcion-regreso').value;

            let transporteIda = '';
            const transporteIdaCheckboxes = document.querySelectorAll('input[name="transporte_ida"]:checked');
            if (transporteIdaCheckboxes.length > 0) {
                transporteIda = transporteIdaCheckboxes[0].value;
            }
            const transporteIdaOtro = document.getElementById('transporte-ida-otro').value;

            let transporteRegreso = '';
            const transporteRegresoCheckboxes = document.querySelectorAll('input[name="transporte_regreso"]:checked');
            if (transporteRegresoCheckboxes.length > 0) {
                transporteRegreso = transporteRegresoCheckboxes[0].value;
            }
            const transporteRegresoOtro = document.getElementById('transporte-regreso-otro').value;

            const rutaAlternaRequerida = document.querySelector('input[name="ruta_alterna"]:checked')?.value === 'SI';
            const rutaAlternaDescripcion = document.getElementById('ruta-alterna-descripcion').value;
            const horaSalidaIda = document.getElementById('hora-salida-ida').value;

            const formData = {
                cedula: cedula,
                origen: origen,
                destino: destino,
                transporte_ida: transporteIda,
                transporte_ida_otro: transporteIda === 'Otro' ? transporteIdaOtro : '',
                transporte_regreso: transporteRegreso,
                transporte_regreso_otro: transporteRegreso === 'Otro' ? transporteRegresoOtro : '',
                ruta_alterna_requerida: rutaAlternaRequerida,
                ruta_alterna_descripcion: rutaAlternaDescripcion,
                hora_salida_ida: horaSalidaIda,
            };

            const rutaFormMessage = document.getElementById('ruta-form-message');
            rutaFormMessage.textContent = 'Guardando declaración...';
            rutaFormMessage.className = 'text-center mt-4 text-lg font-medium text-blue-600';

            try {
                const response = await fetch(`${BACKEND_URL}/api/declaracion_ruta`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                const result = await response.json();

                if (response.ok) {
                    // Mostrar mensaje flotante
                    const toast = document.getElementById('ruta-toast-message');
                    toast.textContent = '¡Declaración guardada exitosamente! No podrá modificarla más.';
                    toast.classList.remove('hidden');
                    setTimeout(() => { toast.classList.add('hidden'); }, 4000);

                    // Deshabilitar todos los campos del formulario
                    document.querySelectorAll('#habitualRouteForm input, #habitualRouteForm select, #habitualRouteForm textarea, #habitualRouteForm button').forEach(el => {
                        el.disabled = true;
                    });

                    rutaFormMessage.textContent = result.message || 'Declaración guardada exitosamente.';
                    rutaFormMessage.className = 'text-center mt-4 text-lg font-medium text-green-600';
                } else {
                    rutaFormMessage.textContent = 'Error al guardar: ' + (result.error || result.message || 'Error desconocido');
                    rutaFormMessage.className = 'text-center mt-4 text-lg font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error al enviar la declaración de ruta:', error);
                rutaFormMessage.textContent = 'Error de conexión con el servidor al guardar.';
                rutaFormMessage.className = 'text-center mt-4 text-lg font-medium text-red-600';
            }
        });

        // Event listeners para controlar la visibilidad de los campos "Otro" y "Ruta Alterna"
        // Estos IDs son cruciales y deben coincidir con los de tu HTML.

        document.getElementById('transporte-ida-otro-check').addEventListener('change', function() {
            document.getElementById('transporte-ida-otro').classList.toggle('hidden', !this.checked);
        });

        document.getElementById('transporte-regreso-otro-check').addEventListener('change', function() {
            document.getElementById('transporte-regreso-otro').classList.toggle('hidden', !this.checked);
        });

        document.querySelectorAll('input[name="ruta_alterna"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('ruta-alterna-descripcion').classList.toggle('hidden', this.value !== 'SI');
            });
        });

        document.getElementById('cancel-form-btn').addEventListener('click', () => {
            curriculumFormContent.reset();
            resetFormState();
        });

    </script>
    <!-- Mensaje flotante para declaración de ruta -->
<div id="ruta-toast-message" class="fixed bottom-8 right-8 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden"></div>
</body>
</html>
